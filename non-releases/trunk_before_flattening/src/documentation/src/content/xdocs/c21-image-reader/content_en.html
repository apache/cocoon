<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>ImageReader in Cocoon</title>
<link href="http://purl.org/DC/elements/1.0/" rel="schema.DC">
<meta content="Bernhard Huber" name="DC.Creator">
<meta content="Upayavira" name="DC.Creator">
<meta content="This document describes the ImageReader of Cocoon." name="DC.Description">
</head>
<body>
    
<h1>ImageReader</h1>
      
<table>
        
<tr>
          
<td colspan="1" rowspan="1">NAME</td><td colspan="1" rowspan="1">image</td>
        
</tr>
        
<tr>
          
<td colspan="1" rowspan="1">WHAT</td><td colspan="1" rowspan="1">The <span class="codefrag">ImageReader</span> component is used 
            to serve binary image data in a sitemap pipeline.
          </td>
        
</tr>
        
<tr>
          
<td colspan="1" rowspan="1">TYPE</td><td colspan="1" rowspan="1">Reader, Sitemap Component</td>
        
</tr>
        
<tr>
          
<td colspan="1" rowspan="1">BLOCK</td><td colspan="1" rowspan="1">Core</td>
        
</tr>
        
<tr>
          
<td colspan="1" rowspan="1">CLASS</td><td colspan="1" rowspan="1">org.apache.cocoon.reading.ImageReader</td>
        
</tr>
        <!--tr>
          <td>DEPRECATED</td><td>Cocoon 2.0, 2.1</td>
        </tr-->
        
<tr>
          
<td colspan="1" rowspan="1">SINCE</td><td colspan="1" rowspan="1">Cocoon 2.1</td>
        
</tr>
        
<tr>
          
<td colspan="1" rowspan="1">CACHEABLE</td><td colspan="1" rowspan="1">yes</td>
        
</tr>
      
</table>
    
    
<h1>Description</h1>
    
<p>
      The <span class="codefrag">ImageReader</span> component is used to serve binary image data
      in a sitemap pipeline. 
    </p>
    
    
<h1>Usage</h1>
      
<p>
      
</p>
      
<h2>Sitemap pipeline examples</h2>
<p>
          The <span class="codefrag">ImageReader</span> is used in a pipline as shown in the
          pipeline snippet below:
        </p>
<pre class="code">
&lt;map:match pattern="*.jpg"&gt;
  &lt;map:read type="image" 
    src="resources/images/{1}.jpg" 
    mime-type="image/jpeg"&gt;
    &lt;!-- optional setup parameters --&gt;
  &lt;/map:read&gt;
&lt;/map:match&gt;
</pre>
<p>
          It is important to specify the <span class="codefrag">mime-type</span> attribute,
          as it is passed to the browser as the <span class="codefrag">Content-Type</span>
          in the <span class="codefrag">HTTP</span> response.
        </p>
      
<h2>Sitemap component configuration example</h2>
<p>
          A <span class="codefrag">ImageReader</span> is declared in the sitemap readers
          section, as shown in the sitemap readers snippet below:
        </p>
<pre class="code">
&lt;map:readers default="resource"&gt;
...
  &lt;map:reader name="image" 
    src="org.apache.cocoon.reading.ImageReader"
    logger="sitemap.reader.image" 
    pool-max="32"/&gt;
    &lt;!-- optional reader configuration --&gt;
    ...
  &lt;/map:readers&gt;
...
        </pre>
      
<h2>Configuration</h2>
<p>
          The <span class="codefrag">ImageReader</span> has no configuration options. 
        </p>
      
<h2>Sitemap Parameters</h2>
<p>
          The <span class="codefrag">ImageReader</span> accepts following sitemap
          setup parameters:
        </p>
<table>
          
<tr>
<th colspan="1" rowspan="1">Parameter Name</th><th colspan="1" rowspan="1">Type</th><th colspan="1" rowspan="1">Comment</th>
</tr>
          
<tr>
            
<td colspan="1" rowspan="1">expires</td>
            <td colspan="1" rowspan="1">Time in milliseconds</td>
            <td colspan="1" rowspan="1">
              This parameter is optional. When specified it determines how long
              in miliseconds the resources can be cached by any proxy or browser
              between Cocoon2 and the requesting visitor.
            </td>
          
</tr>
          
<tr>
            
<td colspan="1" rowspan="1">width</td>
            <td colspan="1" rowspan="1">Image width in pixels</td>
            <td colspan="1" rowspan="1">
              This parameter is optional. When specified it determines the
              width of the binary image.
              If no height parameter is specified, the aspect ratio
              of the image is kept.
            </td>
          
</tr>
          
<tr>
            
<td colspan="1" rowspan="1">height</td>
            <td colspan="1" rowspan="1">Image height in pixels</td>
            <td colspan="1" rowspan="1">
              This parameter is optional. When specified it determines the
              height of the binary image.
              If no width parameter is specified, the aspect ratio
              of the image is kept.
            </td>
          
</tr>
          
<tr>
            
<td colspan="1" rowspan="1">allow-enlarging</td>
            <td colspan="1" rowspan="1">boolean</td>
            <td colspan="1" rowspan="1">
              This parameter is optional. The <span class="codefrag">width</span> and <span class="codefrag">height</span> parameters allow an image 
              to be resized. By default, if the image is smaller than the specified 
              width and height, the image will be enlarged. In some circumstances, this
              behaviour is undesirable, and can be switched off by setting this parameter
              to "<span class="codefrag">false</span>". With this parameter set to "<span class="codefrag">false</span>", images will 
              be reduced in size, but not enlarged. The default for this parameter is 
              "<span class="codefrag">true</span>".
            </td>
          
</tr>
          
<tr>
            
<td colspan="1" rowspan="1">fit-uniform</td>
            <td colspan="1" rowspan="1">boolean</td>
            <td colspan="1" rowspan="1">
              This parameter is optional.  When set to
              "<span class="codefrag">true</span>", it constrains the image size to the
              dimensions of the specified width and height, while
              preserving the original aspect ratio.  The value of
              <span class="codefrag">&lt;allow-enlarging&gt;</span> is honored.  If
              <span class="codefrag">&lt;allow-enlarging&gt;</span> is
              "<span class="codefrag">true</span>", then the image will be enlarged as
              much as possible while still fitting in the "box"; if 
              <span class="codefrag">&lt;allow-enlarging&gt;</span> is
              "<span class="codefrag">false</span>," the image may be reduced to fit the
              box, but never enlarged.  The default
              setting of <span class="codefrag">&lt;fit-uniform&gt;</span> is
              "<span class="codefrag">false</span>".
            </td>
          
</tr>
          
<tr>
            
<td colspan="1" rowspan="1">grayscale</td>
            <td colspan="1" rowspan="1">boolean</td>
            <td colspan="1" rowspan="1">
              This parameter is optional. When specified and set to true it
              will cause each image pixel to be normalized.
              The default for this parameter is "<span class="codefrag">false</span>".
            </td>
          
</tr>
          
<tr>
            
<td colspan="1" rowspan="1">scale(Red|Green|Blue)</td>
            <td colspan="1" rowspan="1">float</td>
            <td colspan="1" rowspan="1">(Optional) Scale the RGB colour components by a multiplication factor.</td>
          
</tr>
          
<tr>
            
<td colspan="1" rowspan="1">offset(Red|Green|Blue)</td>
            <td colspan="1" rowspan="1">float</td>
            <td colspan="1" rowspan="1">(Optional) Offset the RGB colour components by an increment.</td>
          
</tr>
        
</table>
<p>
          The following pipeline snippet
          uses the <span class="codefrag">ImageReader</span> for serving images
          having an expiration time of 1 day (ie. 24 * 60 * 60 * 1000 ms = 86400000 ms), 
          and scaling images to width 300 pixels.
        </p>
<pre class="code">
&lt;map:match pattern="*.jpg"&gt;
  &lt;map:reader type="image" 
    &lt;map:parameter name="expires" value="86400000"/&gt;
    &lt;map:parameter name="width" value="300"/&gt;
  &lt;/map:reader&gt;
...
        </pre>
      
<h2>Effect on Object Model and Sitemap Parameters</h2>
<p>
          The <span class="codefrag">ImageReader</span> does not change object model and sitemap parameters.
          It only access parameter values for reading.
        </p>
    
    
<h1>Bugs/Caveats</h1>
      
<p>
        The <span class="codefrag">ImageReader</span> is able to transform 
        <em>JPEG</em> images only. 
        Nevertheless it can serve any image data in a non transforming mode.
      </p>
      
<p>
        The <span class="codefrag">ImageReader</span> does NOT support HTTP ranges, thus
        it sets <span class="codefrag">Accept-Ranges</span> to <span class="codefrag">none</span>.
      </p>
      
<p>
        The java Bug Id 4502892 (which is found in *all* JVM implementations from
        1.2.x and 1.3.x on all OS!), <span class="codefrag">ImageReader</span> must buffer 
        the JPEG generation to avoid that connection resetting by the peer 
        (user pressing the stop button, for example) crashes the entire JVM. 
        This is evidently fixed in Sun JVM 1.3.1_04 however our workaround
        remains for JVM less than 1.4
      </p>
    
    
<h1>History</h1>
      
<p>
        12-25-02: Initial document creation by Bernhard Huber
        <br>
        01-06-03: Renamed the expire-time -&gt; expires parameter,
                  Fixed the statement about the byte range support, Torsten Curdt
        <br>
        03-07-03: Added allow-enlarging parameter, Upayavira
      </p>
    
    
<h1>See also</h1>
      
<p>
        <!-- Links to related components pages -->
      
</p>
    
  
</body>
</html>
