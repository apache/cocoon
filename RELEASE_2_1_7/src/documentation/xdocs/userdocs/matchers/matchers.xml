<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright 1999-2004 The Apache Software Foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<!DOCTYPE document PUBLIC "-//APACHE//DTD Documentation V1.0//EN" "document-v10.dtd">

<document>
  <header>
    <title>Matchers</title>
    <subtitle>in Cocoon</subtitle>
    <version>0.9</version>
    <type>Technical document</type>
    <authors>
      <person name="Carsten Ziegeler" email="cziegeler@apache.org"/>
      <person name="Gianugo Rabellino" email="gianugo@rabellino.it"/>
      <person name="Diana Shannon, ed." email="shannon@apache.org"/>
     </authors>
     <abstract>This document describes all of the available matchers of Cocoon.</abstract>
  </header>
  <body>
     <s1 title="Goal">
      <p>
      This document lists all of the available matchers of Apache Cocoon and
      describes their purpose.
      See also the concepts document
      <link href="../concepts/matchers_selectors.html">Using and Implementing
      Matchers and Selectors</link>.
      </p>
     </s1>
     <s1 title="Overview">
      <p>
      A matcher is a core sitemap component of Cocoon. Matchers allow Cocoon 
      to associate a pure
      &quot;virtual&quot; URI space with a given set of &quot;instructions&quot;
      found in a Cocoon sitemap. Sitemap matchers are used to determine the flow and order 
      of request processing. They typically describe
      how to generate, transform and present a requested resource(s) to
      the client. They may also be used to redirect requests to other pipelines
      or to call other sitemap resources.
      </p>
      <p>
      Cocoon is driven by the client request. A request typically
      contains a URI, some parameters, cookies, and much more. Within 
      the Cocoon environment, the request is evaluated to determine
      what sitemap instructions to use for processing. 
      More specifically, a given request is matched against a pipeline 
      matcher's pattern attribute. When a match is found,
      processing of the request begins.
      </p>
      <p>
      As an example, consider the following sitemap snippet:
      </p>
<source>
<![CDATA[
<map:match pattern="body-faq.xml">
  <map:generate src="xdocs/faq.xml"/>
  <map:transform src="stylesheets/faq2document.xsl"/>
  <map:transform src="stylesheets/document2html.xsl"/>
  <map:serialize/>
</map:match>

<map:match pattern="body-**.xml">
  <map:generate src="xdocs/{1}.xml"/>
  <map:transform src="stylesheets/document2html.xsl"/>
  <map:serialize/>
</map:match>
]]>   
</source>
      <p>
      Here the two sitemap entries map request URIs to different virtual URIs using
      the default wildcard matcher (defined earlier in a matcher component configuration).
      The first entry uses an exact match, &quot;body-faq.xml&quot;. Only request URIs
      composed of this exact string will match this entry. The
      second sitemap entry uses a wildcard pattern. URI Requests that begin with
      &quot;body-&quot; and end with &quot;.xml&quot; will meet this matcher's
      requirement. For example, a URI request for &quot;body-cocoon.xml&quot; 
      would match the second entry.
      </p>
     </s1>
     <s1 title="Order">
       <p>
       It's important to understand that Cocoon is based on a "first-match"
       approach. All requests are matched against the different "map:match"
       entries in the order in which matchers are specified in the sitemap.
       As soon
       as a match is successful, the pipeline processing begins. This means
       that more specific patterns must appear before more generic ones. 
       If the order of the two pipelines in the above example were reversed,
       a request for "body-faq.xml" not match &quot;body-faq.xml&quot;
       but &quot;body-**.xml&quot; because it appears first. (This is a familiar 
       concept, especially in router and firewall configurations.) 
       </p>
     </s1>
     <s1 title="Tokenization">
       <p>
       Another important feature of matchers is tokenization. Every &quot;variable&quot;
       part of a matcher pattern will be kept in memory by Cocoon for 
       additional reuse. It remains available within a pipeline match
       as a numbered argument. Using the previous example, consider a request 
       URI such as &quot;body-index.xml&quot; matched by the second map:match element.
       The string &quot;index&quot; which matches the "**" wildcard,
       is available for reuse by other child elements of map:match. It is
       identified by the key {1}. This key is used as a parameter for the 
       generator which will first resolve it to the string 
       &quot;index&quot;, and then look for a file named &quot;xdocs/index.html&quot;.  
       </p>
     </s1>
     <s1 title="Wildcard and regular expressions">
       <p>
       Most Cocoon matchers are built using two different techniques:
       regular expressions and wildcards.
       Regular expressions (or regexps) are a well-known and powerful 
       system for pattern matching. Learning how to master them is beyond 
       the scope of this document. However, you will find a lot of documentation 
       on the web regarding this topic.
       </p>
       <p>
       Although powerful, regexps can be overkill for most
       typical Cocoon use cases where simple matching operations
       are performed. This is why Cocoon offers a simplified
       pattern matching system based on a small set of basic rules.
       </p>
       <ul>
        <li>
        An asterisk ('*') matches zero or more characters,
        up to the occurrence of a '/' character (which serves as
        a path separator). A string, such as &quot;/cocoon/docs/index.html&quot;, 
        would <em>not</em>
        match successfully against the pattern '/*/*.index.html'. 
        The first asterisk matches up to the first path
        separator only, resulting in the &quot;cocoon&quot; string. 
        A successful matching pattern would be '/*/*/*.html'.
        </li>
        <li>
        A string containing two asterisks ('**') matches zero or more 
        characters. This could include the path separator '/'. 
        In this case, &quot;/cocoon/docs/index.html&quot; would successfully
        match the '/**/*.html' pattern. The double asterisk, including the
        path separator, would match the &quot;cocoon/docs&quot; string.
        </li>
        <li>
        As with regexps, the backslash character ('\') is used to indicate an 
        escape sequence. The string '\*' will match an actual asterisk
        while a double backslash ('\\') will match the character '\'. A
        pattern such as "**/a-\*-is-born.html" would match strings
        such as &quot;documents/movies/a-*-is-born.html&quot; or 
        &quot;a/very/long/path/a-*-is-born.html&quot;. It would <em>not</em> match
        the string &quot;docs/a-star-is-born.html&quot;.
        </li>
       </ul>
     </s1>
     <s1 title="Matchers in Cocoon">
       <ul>
         <li><strong>WildCard URI matcher</strong>(The default matcher): matches the URI against a wildcard pattern.</li>
         <li><strong>Regexp URI matcher:</strong> 
         matches the URI against a full-blown regular expression</li>
         <li><strong>Request parameter 
         matcher:</strong> matches a request parameters given as a pattern. If
         the parameter exists, its value is available for later substitution.
         </li>
         <li><strong>Wildcard request parameter matcher:</strong> matches a wildcard 
         given as a pattern against the <strong>value</strong> of a configured 
         parameter.
         </li>
         <li><strong>Wildcard session parameter matcher</strong>: similar to the 
         Wildcard request parameter matcher, but it matches a session parameter.</li>
      </ul>
    </s1>
  </body>
</document>
