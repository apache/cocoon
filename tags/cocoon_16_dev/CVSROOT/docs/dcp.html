<html>

<head>
<meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<meta name="AUTHOR" content="Ricardo Rocha">
<title>Cocoon - Dynamic Content Processor User Guide</title>
</head>

<body BGCOLOR="#FFFFFF">

<p><img src="images/logo.gif" border="0"></p>

<h1 align="center"> Dynamic Content Processor (DCP) User Guide</h1>

<p align="center"> by Ricardo Rocha</p>

<h2>Introduction</h2>

<blockquote>
  <p>In addition to static content (that is, hand-written documents produced by web
  authors), web publishing also requires <i>dynamic content generation</i>. In dynamic content generation, XML documents or fragments are programmatically produced
  at request time.&nbsp; </p>
  <p> In this context, content is the result of a computation based on request
  parameters and, frequently, on access to external data sources such as databases or remote
  server processes. This distinction in content origin justifies the extension of the
  &quot;traditional&quot; regions of web publishing (content and presentation) to also
  encompass that of <i>logic</i>. </p>

<h3>Origins</h3>

  <blockquote>
  <p>The Cocoon community has long recognized the need for dynamic content generation
  capabilities. In response to this requirement, the Cocoon project has proposed
  <a href="http://java.apache.org/cocoon/xsp/WD-xsp.html">XSP</a> (<i>eXtensible Server Pages</i>).
  XSP defines a new XML DTD and namespace that addresses a complete region of web
  publishing, that of logic-based, dynamic content generation. XSP is a key
  component of the future versions of Cocoon and it's not yet implemented.
  </p>
  <p>DCP (<i>Dynamic Content Processor</i>), on the other hand, aims at providing
  easy-to-use dynamic content generation capabilities in the context of the current version
  of Cocoon. DCP is also a testbed for implementation-related issues in the upcoming development of
  XSP. These issues include aspects such as multiple language support, automatic code
  reloading and code reuse. </p>
  </blockquote>

<h3>DCP Goals</h3>

  <blockquote>
  <p>DCP has been designed to provide dynamic content generation capabilities to Cocoon
  with the following goals in mind: <ul>
    <li>Minimal changes to the current architecture. </li>
    <li>Maximal ease of use for authors and developers. </li>
    <li>Avoiding XSP implementation complexities while still providing a useful facility for
      dynamic content generation. </li>
  </ul>
  <p>In order to maximize ease of use, the following early decisions were made for DCP: <ul>
    <li>Other than the source XML document itself, no external documents should be required to
      map inline dynamic content generation directives to external programs. </li>
    <li>External programs should be as easy to write as possible. In addition to Java, it should
      be possible to also write external programs in easy-to-use scripting languages. </li>
  </ul>
  <p>By restricting the use of external documents (such as XSP's <i>logicsheets</i>) to
  specify how to map content generation directives to external programs, the obvious choice
  was the use of processing instructions (e.g. <i>&lt;?dcp-object?&gt;</i>, <i>&lt;?dcp-content?&gt;</i>).
  </p>
  <p>This decision results in a number of limitations when compared to the more general
  mechanism of transforming DOM <i>elements</i> (as opposed to processing instructions). </p>
  <p>One such limitation is that passing [static] parameters to external programs is limited
  to the single-valued pseudo-attributes used in processing instructions. Closer inspection
  reveals, however, that this mechanism is appropriate for a large number of dynamic content
  generation requirements. </p>
  <p>Keeping external program writing simple means not requiring programmers to learn a new
  API or to follow restrictive coding conventions. The ability to write programs in
  easy-to-use scripting languages also contributes to simplifying development. This is
  particularly appealing, for instance, to web authors already familiar with Javascript. In
  addition to Java, Javascript is currently supported, with plans to include <a
  href="http://www.research.digital.com/SRC/WebL/">WebL</a> in the near future. </p>
  <p>Jean-Marc Lugrin's (<a href="http://home.worldcom.ch/jmlugrin/fesi/index.html">Fesi</a>)
  (<i>Free EcmaScript Interpreter</i>) is used to provide support for Javascript. </p>
  </blockquote>

<h3>Relationship with Existing Technologies</h3>

  <blockquote>
  <p>DCP (and XSP, for that matter) differs from existing dynamic web content generation
  technologies in that it deals with DOM trees rather than with the textual representation
  of HTML documents. </p>
  <p>Such technologies, however, have had a strong influence in DCP's design both because
  they pioneered programmatic web content generation and because DCP (and, again, XSP) aims
  at overcoming their limitations in the realm of XML-based document processing. </p>
  <p><a href="http://www.javasoft.com/products/jsp/index.html">JSP</a>, in particular, is a
  widely used standard in the Java environment. Other comparable technologies are
  Microsoft's <a
  href="http://www.microsoft.com/ntserver/web/deployment/planguide/WebAppDev.asp">ASP</a>, <a
  href="http://www.coldfusion.com/">Cold Fusion</a>, Sun's [deprecated] <a
  href="http://www.sun.com/software/jwebserver/features/index.html#dsp">Page Compilation</a>,
  <a href="http://www.webmacro.org/">Webmacro</a> and <a
  href="http://www.bitmechanic.com/projects/gsp">GSP</a>. </p>
  <p>These technologies share three common characteristics: <ul>
    <li><b>Text-based</b>. Not being XML-aware, these technologies deal with textual streams,
      rather than with DOM trees or SAX events. </li>
    <li><b>Html-oriented</b>. Generation capabilities have been designed with HTML in mind and
      do not lend themselves easily to produce XML. </li>
    <li><b>No separation of logic and content</b>. Probably their most problematic area; these
      technologies mix content and program logic in the same document. This impairs labor
      division in web publishing. </li>
  </ul>
  <p>DCP and XSP, on the other hand, aim at a complete separation of logic and content. </p>
  <p>In DCP, web authors specify dynamic content insertion using a simple, standard XML
  syntax while programmers concentrate on content generation without being concerned by
  context or presentation issues. </p>
  <p>Finally, the difference between DCP and XSP is that while DCP is interpreted
  and executed at runtime, XSP page are compiled and executed directly as
  document producers. This allows better separation of content and logic (since
  the XSP pages can be processed like regular document at first) and increased
  performance (since no interpretation is required and compiled pages are
  cached). </p>
  </blockquote>

</blockquote>

<h2>DCP Installation and Configuration</h2>

<blockquote>
  <p>The Cocoon distribution comes already configured for DCP use and contains all libraries and files required to use
  DCP in its Java version. For Javascript support, you need to download the <a
  href="http://www.distributedsystems.com/cocoon/dcp/lib/fesi.jar">Fesi runtime library</a>. </p>
</blockquote>

<h2>A Simple Javascript Example</h2>

<blockquote>
  <p>Consider the following dynamic Cocoon XML document (<a
  href="http://www.distributedsystems.com/cocoon/dcp/example/ecmascript/sample.xml?country=Canada&amp;language=English&amp;language=French">sample.xml</a>):
  </p>
  <div align="center"><center><table border="1" bgcolor="lightBlue">
    <tr>
      <td><h3 align="center">A Dynamic Cocoon Page</h3>
      <p>Hi, I'm a dynamic page generated by <strong>Cocoon</strong> on <font color="red">06/06/1999</font>.
      </p>
      <p>During my current incarnation, I've been hit <font color="red">7</font> times. </p>
      <p>The following is the list of parameters for this request: </p>
      <div align="center"><center><table border="1">
        <caption><i><b>Parameters</b></i></caption>
        <tr>
          <th>Name</th>
          <th>Value(s)</th>
        </tr>
        <tr>
          <td valign="top"><font color="red">country</font></td>
          <td valign="top"><table>
            <tr>
              <td><font color="red">Canada</font></td>
            </tr>
          </table>
          </td>
        </tr>
        <tr>
          <td valign="top"><font color="red">language</font></td>
          <td valign="top"><table>
            <tr>
              <td><font color="red">English</font></td>
            </tr>
            <tr>
              <td><font color="red">French</font></td>
            </tr>
          </table>
          </td>
        </tr>
      </table>
      </center></div></td>
    </tr>
  </table>
  </center></div><p>In this example, portions shown in red are to be dynamically generated
  every time the document is requested. </p>
  <p>For this to be achieved, three separate components must be written: <ul>
    <li>A <i>source XML file</i> containing the static portions of the document and some dynamic
      content insertion directives. </li>
    <li>A <i>DCP script</i> containing DOM node-generation functions. This script can be used by
      many different XML documents. </li>
    <li>An <i>XSL stylesheet</i> containing transformation rules to generate HTML from the
      (expanded) XML document. Again, this stylesheet can be used by many different XML
      documents. </li>
  </ul>
  <p><i>Dynamic content insertion directives</i> are DCP processing instructions used to
  specify how to generate dynamic content and where to substitute such content. </p>
  <p align="justify">The following processing instructions are recognized: </p>
  <ul>
    <li><pre><font color="green">&lt;?</font><font color="brown"><b>dcp-object</b></font> <font
color="darkGreen">name</font>=<font color="magenta">&quot;<i>objectName</i>&quot;</font> [<font
color="darkGreen">language</font>=<font color="magenta">&quot;<i>languageName</i>&quot;</font>] <font
color="darkGreen">code</font>=<font color="magenta">&quot;<i>codeLocation</i>&quot;</font><font
color="green">?&gt;</font></pre>
      <p align="justify">This instruction declares an external program (or <i>DCP script</i>)
      that contains node-generation methods. These methods will be invoked during document
      processing as dictated by the appearance of subsequent <i><font color="green">&lt;?</font><font
      color="brown">dcp-content?</font><font color="green">&gt;</font></i> directives (explained
      below). </p>
      <p align="justify">Attribute <font color="darkGreen"><i>name</i></font> specifies an
      author-defined <font color="magenta"><i>objectName</i></font> that will be used to qualify
      method names in the DCP script. This name must be unique within the document. </p>
      <p align="justify">Attribute <font color="darkGreen"><i>language</i></font> specifies the
      programming language in which the DCP script is written. Supported values for this
      attribute are <font color="magenta"><i>java</i></font> and <font color="magenta"><i>javascript</i></font>
      (also referred to as <font color="magenta"><i>ecmascript</i></font>). This attribute is
      optional; its default value is <font color="magenta"><i>java</i></font>. Other languages
      may be added in the future. It is valid for the same XML document to use multiple DCP
      scripts written in different languages. </p>
      <p align="justify">Attribute <font color="darkGreen"><i>code</i></font> specifies the
      actual DCP script location. Interpretation of this mandatory attribute is
      language-dependent. For Java, it is a fully qualified class name. For Javascript, it is a
      script filename relative to the path of the invoking XML document. The same code can be
      specified multiple times in a given document, provided a different <font color="magenta"><i>objectName</i></font>
      is used in each case. </p>
    </li>
    <li><pre><font color="green">&lt;?</font><font color="brown">dcp-content</font> <font
color="darkGreen">method</font>=<font color="magenta">&quot;<i>object.method</i>&quot;</font> [<font
color="darkGreen">param1</font>=<font color="magenta">&quot;<i>value</i>&quot;</font> <font
color="darkGreen">param2</font>=<font color="magenta">&quot;<i>value</i>&quot;</font> ...] <font
color="green">?&gt;</font></pre>
      <p align="justify">This instruction requests the substitution of its corresponding node by
      the return value of a named <i>method</i> defined in a DCP script. </p>
      <p align="justify">Single-valued, named parameters can be passed to node-generation
      methods by specifying additional attributes in the <font color="green">&lt;?</font><font
      color="brown"><i>dcp-content</i></font><font color="green">?&gt;</font> processing
      instruction. These attributes are made available to the method through a <code><i>Dictionary</i></code>
      argument. </p>
      <p align="justify">Attribute <font color="darkGreen"><i>method</i></font> defines what <font
      color="magenta"><i>method</i></font> to invoke on a given <font color="magenta"><i>object</i></font>.
      The object name must have been associated with a DCP script by means of a previous <font
      color="green">&lt;?</font><font color="brown"><i>dcp-object</i></font><font color="green">?&gt;</font>
      processing instruction. Node-generation methods must be public and conform to the
      following signature: </p>
      <blockquote>
        <pre><font color="brown"><i>methodName</i></font>(
     [<font color="blue">java.util.Dictionary parameters</font>],
     [<font
color="blue">org.w3c.Node source</font>]
 )</pre>
      </blockquote>
      <p align="justify">where the optional function arguments are: </p>
      <ul>
        <li><font color="blue"><i>parameters</i></font>. A dictionary containing any optional named
          parameters specified as additional attributes to the <font color="green">&lt;?</font><font
          color="brown"><i>dcp-content</i></font><font color="green">?&gt;</font> processing
          instruction. </li>
        <li><font color="blue"><i>source</i></font>. The processing instruction node corresponding
          to the <font color="green">&lt;?</font><font color="brown"><i>dcp-content</i></font><font
          color="green">?&gt;</font> directive itself. This is useful for methods that need access
          to siblings or ancestors in the DOM tree. </li>
      </ul>
      <p align="justify">Methods can return any type of value, including primitive types, <i>void</i>
      and <i>null</i>. <i>Void</i> and <i>null</i> are understood as a request to remove the
      corresponding node. Returned values that are instances of <i>org.w3c.Node</i> are simply
      inserted into the corresponding DOM tree position. Primitive types and regular objects are
      wrapped as strings in <i>org.w3c.Text</i> nodes. Arrays are wrapped as <i>org.w3c.DocumentFragment</i>'s
      containing as many children as elements in the array; each element is recursively wrapped
      according to the above rules. </p>
    </li>
    <li><pre><font color="green">&lt;?</font><font color="brown">dcp-var</font> <font
color="darkGreen">name1</font>=<font color="magenta">&quot;<i>value1</i>&quot;</font> [<font
color="darkGreen">name2</font>=<font color="magenta">&quot;<i>value2</i>&quot;</font> ...]<font
color="green">?&gt;</font></pre>
      <p aligns="justify">This instruction declares one or more <font color="darkGreen"><i>global
      variables</i></font> that will be passed in each subsequent method invocation as if
      explicitly specified as parameters. </p>
      <p>This mechanism is basically a convenience shorthand to avoid cluttering <font
      color="green">&lt;?</font><font color="brown"><i>dcp-content</i></font><font color="green">?&gt;</font>
      instructions with too long parameter lists. </p>
      <p>Declared variables are global to all subsequent method invocations. For a method to use
      a given global variable as a parameter, it must have been <i>previously</i> declared in
      the same document. </p>
    </li>
  </ul>
  <p>That said, the source XML document for the above example would be: </p>
  <div align="center"><center><table border="1" bgcolor="#fcefc4">
    <tr>
      <td><pre>
  <font color="green">&lt;?</font><font color="brown">xml</font> <font
color="darkGreen">version</font>=<font color="magenta">&quot;1.0&quot;</font><font color="green">?&gt;</font>
  <font
color="green">&lt;?</font><font color="brown">xml-stylesheet</font> <font color="darkGreen">href</font>=<font
color="magenta">&quot;sample.xsl&quot;</font> <font color="darkGreen">type</font>=<font
color="magenta">&quot;text/xsl&quot;</font><font color="green">?&gt;</font>
  
  
  <font
color="green">&lt;</font><font color="brown">page</font><font color="green">&gt;</font>
  <font
color="blue">&lt;!-- Script filename is relative to document path --&gt;</font>
  <font
color="blue">&lt;!-- The names &quot;javascript&quot; and &quot;ecmascript&quot; are interchangeable --&gt;</font>
  <b><font
color="green">&lt;?</font><font color="brown">dcp-object</font> <font color="darkGreen">name</font>=<font
color="magenta">&quot;util&quot;</font> <font color="darkGreen">language</font>=<font
color="magenta">&quot;javascript&quot;</font> <font color="darkGreen">code</font>=<font
color="magenta">&quot;test.es&quot;</font><font color="green">?&gt;</font></b>
  
   <font
color="green">&lt;</font><font color="brown">title</font><font color="green">&gt;</font>A Dynamic Javascript Cocoon Page<font
color="green">&lt;</font><font color="brown">/title</font><font color="green">&gt;</font>
  
   <font
color="green">&lt;</font><font color="brown">p</font><font color="green">&gt;</font>
     Hi, I'm a dynamic Javascript page generated by <font
color="green">&lt;</font><font color="brown">em</font><font color="green">&gt;</font>Cocoon<font
color="green">&lt;</font><font color="brown">/em</font><font color="green">&gt;</font> on
     <b><font
color="green">&lt;?</font><font color="brown">dcp-content</font> <font color="darkGreen">method</font>=<font
color="magenta">&quot;util.getSystemDate&quot;</font> <font color="darkGreen">format</font>=<font
color="magenta">&quot;MM/dd/yyyy&quot;</font><font color="green">?&gt;</font></b>.
   <font
color="green">&lt;</font><font color="brown">/p</font><font color="green">&gt;</font>
  
   <font
color="green">&lt;</font><font color="brown">p</font><font color="green">&gt;</font>
     During my current incarnation, I've been hit
     <b><font
color="green">&lt;?</font><font color="brown">dcp-content</font> <font color="darkGreen">method</font>=<font
color="magenta">&quot;util.getCount&quot;</font><font color="green">?&gt;</font></b>
     times.
   <font
color="green">&lt;</font><font color="brown">/p</font><font color="green">&gt;</font>
  
   <font
color="green">&lt;</font><font color="brown">p</font><font color="green">&gt;<b>&lt;?</font><font
color="brown">dcp-content</font> <font color="darkGreen">method</font>=<font color="magenta">&quot;util.getParameters&quot;</font><font
color="green">?&gt;</b>&lt;</font><font color="brown">/p</font><font color="green">&gt;</font>
  </pre>
      </td>
    </tr>
  </table>
  </center></div><p>In this document: <ul>
    <li>The processing instruction <pre>  <font color="green">&lt;?</font><font color="brown">dcp-object</font> <font
color="darkGreen">name</font>=<font color="magenta">&quot;util&quot;</font> <font
color="darkGreen">language</font>=<font color="magenta">&quot;javascript&quot;</font> <font
color="darkGreen">code</font>=<font color="magenta">&quot;test.es&quot;</font><font
color="green">?&gt;</font></pre>
      <p>declares the existence of an external Javascript program contained in a file called <i><font
      color="magenta">test.es</font></i>. </p>
      <p>Subsequent references to file <i><font color="magenta">test.es</font></i> will use the
      alias <i><font color="magenta">util</font></i>. </p>
    </li>
    <li>The processing instruction <pre>  <font color="green">&lt;?</font><font color="brown">dcp-content</font> <font
color="darkGreen">method</font>=<font color="magenta">&quot;util.getSystemDate&quot;</font> <font
color="darkGreen">format</font>=<font color="magenta">&quot;MM/dd/yyyy&quot;</font><font
color="green">?&gt;</font></pre>
      <p>specifies that function <i><font color="magenta">getSystemDate</font></i> (contained in
      file <i><font color="magenta">test.es</font></i>) must be called and its return value
      substituted in the document position where the <i><font color="green">&lt;?</font><font
      color="brown">dcp-content</font><font color="green">?&gt;</font></i> directive appeared. </p>
      <p>Furthermore, when this function is called, it is passed a parameter of name <i><font
      color="green">format</font></i> and value <i><font color="magenta">MM/dd/yyyy</font></i>. </p>
    </li>
  </ul>
  <p>The initial portion of the script file <i><font color="magenta">test.es</font></i>
  contains: </p>
  <pre>
  <font color="darkGreen">var</font> count = 0;
  
  /* Node Generation Functions */
  <font
color="green">function</font> getCount() {
    <font color="blue">/* To reference variables as static, prepend &quot;global.&quot; */</font>
    <font
color="brown">return</font> formatCount(++<b>global</b>.count);
  }
  
  <font color="green">function</font> getSystemDate(parameters) {
    <font
color="darkGreen">var</font> now = new Date();
    <font color="darkGreen">var</font> format = parameters.get(<font
color="magenta">&quot;format&quot;</font>);
  
    <font color="brown">if</font> (format != null) {
      <font
color="brown">return</font> formatDate(now, format);
    }
  
    <font color="brown">return</font> now;
  }
  </pre>
  <p>DCP automatically reloads Javascript script files whenever they change on disk. </p>
  <p>When a global variable must be treated as static, references to it must be qualified by
  the <i>global</i> modifier. This is convenient when the programmer wants the variable to
  retain its value across requests. </p>
  <p>For functions returning simple object values, DCP takes care of wrapping the returned
  value as an <code><i>org.w3c.dom.Text</i></code> node containing the <i>toString()</i>
  form of the object. When a function returns <i>null</i>, the corresponding node is removed
  from the DOM tree. </p>
  <p>Of course, returned values can be instances of a DOM <i>Node</i> type. This is
  illustrated by the function <i><font color="magenta">getParameters</font></i> below: </p>
  <pre>  <font color="green">function</font> getParameters() {
    <font color="darkGreen">var</font> parameterNames = <b>request</b>.getParameterNames();
  
    <font
color="brown">if</font> (!parameterNames.hasMoreElements()) {
      <font color="brown">return</font> null;
    }
  
    <font
color="darkGreen">var</font> parameterList = createElement(<font color="magenta">&quot;parameters&quot;</font>);
  
    <font
color="brown">while</font> (parameterNames.hasMoreElements()) {
      <font color="darkGreen">var</font> parameterName = parameterNames.nextElement();
  
      <font
color="darkGreen">var</font> parameterElement = createElement(<font color="magenta">&quot;parameter&quot;</font>);
      parameterElement.setAttribute(<font
color="magenta">&quot;name&quot;</font>, parameterName);
  
      <font color="darkGreen">var</font> parameterValues = <b>request</b>.getParameterValues(parameterName);
  
      <font
color="brown">for</font> (var i = 0; i &lt; parameterValues.length; i++) {
        <font
color="darkGreen">var</font> valueElement = createElement(<font color="magenta">&quot;parameter-value&quot;</font>);
        valueElement.appendChild(createTextNode(parameterValues[i]));
        parameterElement.appendChild(valueElement);
      }
  
      parameterList.appendChild(parameterElement);
    }
  
    <font
color="brown">return</font> parameterList;
  }  </pre>
  <p>Thus, if our example processes the request: </p>
  <blockquote>
    <font color="navy"><code><p>sample.xml?me=Tarzan&amp;you=Jane&amp;you=Cheetah</code></font>
    </p>
  </blockquote>
  <p>the above function would generate a DOM subtree equivalent to the following XML
  fragment: </p>
  <blockquote>
    <pre>  <font color="green">&lt;</font><font color="brown">parameters</font><font
color="green">&gt;</font>
  
    <font color="green">&lt;</font><font color="brown">parameter</font> <font
color="darkGreen">name</font>=<font color="magenta">&quot;me&quot;</font><font color="green">&gt;</font>
      <font
color="green">&lt;</font><font color="brown">parameter-value</font><font color="green">&gt;</font>Tarzan<font
color="green">&lt;</font><font color="brown">/parameter-value</font><font color="green">&gt;</font>
    <font
color="green">&lt;</font><font color="brown">/parameter</font><font color="green">&gt;</font>
  
    <font
color="green">&lt;</font><font color="brown">parameter</font> <font color="darkGreen">name</font>=<font
color="magenta">&quot;you&quot;</font><font color="green">&gt;</font>
      <font color="green">&lt;</font><font
color="brown">parameter-value</font><font color="green">&gt;</font>Jane<font color="green">&lt;</font><font
color="brown">/parameter-value</font><font color="green">&gt;</font>
      <font color="green">&lt;</font><font
color="brown">parameter-value</font><font color="green">&gt;</font>Cheetah<font color="green">&lt;</font><font
color="brown">/parameter-value</font><font color="green">&gt;</font>
    <font color="green">&lt;</font><font
color="brown">/parameter</font><font color="green">&gt;</font>
  
  <font color="green">&lt;</font><font
color="brown">/parameters</font><font color="green">&gt;</font>  </pre>
  </blockquote>
  <p>The general signature for a dynamic content generation Javascript function is: </p>
  <blockquote>
    <code><font color="green"><p>function</font> <i>functionName</i>(<font color="navy">parameters</font>,
    <font color="navy">source</font>) </code></p>
  </blockquote>
  <p>where: <ul>
    <li><font color="navy"><i>parameters</i></font> is an instance of <code><i>java.util.Dictionary</i></code>
      containing user-supplied parameters specified as <i><font color="green">&lt;?</font><font
      color="brown">dcp-content</font><font color="green">?&gt;</font></i> pseudo-attributes.
      Example: parameter <i><font color="green">format</font></i> in function <i><font
      color="magenta">getSystemDate</font></i>. </li>
    <li><font color="navy"><i>source</i></font> is an instance of <code><i>org.w3c.dom.ProcessingInstruction</i></code>
      corresponding to the actual <i><font color="green">&lt;?</font><font color="brown">dcp-content</font><font
      color="green">?&gt;</font></i> processing instruction. This node is useful for performing
      context-dependent processing such as examining sibling or parent DOM nodes. </li>
  </ul>
  <p>Note: Programmers may omit any or all of these arguments if they are not actually
  needed by the task at hand. </p>
  <p>The following objects are always made available to external Javascript programs as
  global variables: <ul>
    <li><code><font color="navy"><i>javax.servlet.http.HttpServletRequest</i> <b>request</b></font></code>
    </li>
    <li><code><font color="navy"><i>org.w3c.dom.Document</i> <b>document</b></font></code> </li>
  </ul>
  <p>The following convenience functions are made accessible by DCP to external Javascript
  programs: <ul>
    <li>DOM factory functions are provided by DCP for easy construction of DOM nodes: <i><font
      color="navy">createTextNode</font>(data)</i>, <i><font color="navy">createElement</font>(tagName)</i>,
      etc. <p>In general, All DOM factory methods defined for interface <i>org.w3c.dom.Document</i>
      are available as Javascript functions. </p>
    </li>
    <li>Formatting functions for numbers and dates: <ul>
        <li><i>function <font color="navy">formatCount</font>(number)</i>, </li>
        <li><i>function <font color="navy">formatCurrency</font>(number)</i>, </li>
        <li><i>function <font color="navy">formatPercentage</font>(number)</i> and </li>
        <li><i>function <font color="navy">formatDate</font>(date, format)</i>. Date format strings
          conform to the syntax defined by class <code><i>java.text.DateFormat</i></code>. </li>
      </ul>
    </li>
    <li>A JDBC access function <blockquote>
        <i><font color="green"><p>function</font> <font color="navy">sqlRowSet</font>(connectionName,
        selectStatement)</i>, </p>
      </blockquote>
      <p>that returns an array of Javascript objects whose member names are given by the
      lowercase form of each SELECT column label. The array contains as many elements as rows
      are returned by the SELECT statement. </p>
      <p>Parameters to this function are: <ul>
        <li><i>connectionName</i>. Aconnection pool name as specified by Gefion Software's <a
          href="util/DBConnectionManager.html"><code><i><font color="navy">DBConnectionManager</font></i></code>
          </a>in the resource file <a href="util/db_props.html"><font color="brown"><i>db.properties</i></font>.
          </a></li>
        <li><i>selectStatement</i>. A SQL SELECT statement for the database manager in use. </li>
      </ul>
      <p>Thus, for the Oracle <i>demo</i> connection in file <i>db.properties</i>, a sample
      Javascript user function would look like: </p>
      <pre>  <font color="darkGreen">var</font> selectStatement =
    <font color="magenta">&quot;SELECT   <b>EMPNO</b>, &quot;</font> +
    <font
color="magenta">&quot;         <b>ENAME</b>, &quot;</font> +
    <font color="magenta">&quot;         SAL + NVL(COMM, 0) AS <b>INCOME</b> &quot;</font> +
    <font
color="magenta">&quot;FROM     EMP &quot;</font> +
    <font color="magenta">&quot;ORDER BY EMPNO&quot;</font>;

  <font
color="darkGreen">var</font> emps = sqlRowSet(<font color="magenta">&quot;demo&quot;</font>, selectStatement);

  <font
color="brown">for</font> (<font color="darkGreen">var</font> i = 0; i &lt; emps.length; i++) {
    addEmp(emps[i].<b>empno</b>, emps[i].<b>ename</b>, emps[i].<b>income</b>)
  }</pre>
    </li>
  </ul>
  <p>Finally, it is possible, in general, to: <ul>
    <li>Declare multiple external programs in the same XML document. <pre> <font color="green">&lt;?</font><font
color="brown">dcp-object</font> <font color="darkGreen">name</font>=<font color="magenta">&quot;emp&quot;</font> <font
color="darkGreen">language</font>=<font color="magenta">&quot;javascript&quot;</font> <font
color="darkGreen">code</font>=<font color="magenta">&quot;emp.es&quot;</font><font color="green">?&gt;</font>
 <font
color="green">&lt;?</font><font color="brown">dcp-object</font> <font color="darkGreen">name</font>=<font
color="magenta">&quot;dept&quot;</font> <font color="darkGreen">language</font>=<font
color="magenta">&quot;javascript&quot;</font> <font color="darkGreen">code</font>=<font
color="magenta">&quot;dept.es&quot;</font><font color="green">?&gt;</font></pre>
    </li>
    <li>Declare the same external program multiple times in the same XML document, provided
      different names are used for each declaration. <pre>  <font color="green">&lt;?</font><font
color="brown">dcp-object</font> <font color="darkGreen">name</font>=<font color="magenta"><b>&quot;emp&quot;</b></font> <font
color="darkGreen">language</font>=<font color="magenta">&quot;ecmascript&quot;</font> <font
color="darkGreen">code</font>=<font color="magenta"><b>&quot;emp.es&quot;</b></font><font
color="green">?&gt;</font>
  <font color="green">&lt;?</font><font color="brown">dcp-object</font> <font
color="darkGreen">name</font>=<font color="magenta"><b>&quot;boss&quot;</b></font> <font
color="darkGreen">language</font>=<font color="magenta">&quot;ecmascript&quot;</font> <font
color="darkGreen">code</font>=<font color="magenta"><b>&quot;emp.es&quot;</b></font><font
color="green">?&gt;</font></pre>
    </li>
    <li>Mix external programs written in different languages in the same XML document. <pre> <font
color="green">&lt;?</font><font color="brown">dcp-object</font> <font color="darkGreen">name</font>=<font
color="magenta">&quot;emp&quot;</font> <font color="darkGreen">language</font>=<font
color="magenta"><b>&quot;ecmascript&quot;</b></font> <font color="darkGreen">code</font>=<font
color="magenta">&quot;emp.es&quot;</font><font color="green">?&gt;</font>
 <font color="green">&lt;?</font><font
color="brown">dcp-object</font> <font color="darkGreen">name</font>=<font color="magenta">&quot;dept&quot;</font> <font
color="darkGreen">language</font>=<font color="magenta"><b>&quot;java&quot;</b></font> <font
color="darkGreen">code</font>=<font color="magenta">&quot;payroll.Department&quot;</font><font
color="green">?&gt;</font></pre>
    </li>
  </ul>
</blockquote>

<h2>Java DCP Programming</h2>

<blockquote>
  <p>For the Java language, the attribute <i><font color="magenta">code</font></i> in the
  declaration </p>
  <blockquote>
    <pre><font color="green">&lt;?</font><font color="brown">dcp-object</font> <font
color="darkGreen">name</font>=<font color="magenta">&quot;util&quot;</font> <font
color="darkGreen">language</font>=<font color="magenta">&quot;java&quot;</font> <font
color="darkGreen">code</font>=<font color="magenta"><b>&quot;payroll.Employee&quot;</b></font><font
color="green">?&gt;</font></pre>
  </blockquote>
  <p>is interpreted as a class name. Such class must be accessible through the servlet
  engine's <i>classpath</i> setting. </p>
  <p>Node-generation methods in Java conform to the following signature: </p>
  <blockquote>
    <pre><font color="darkGreen">public</font> <i>methodName</i>(
  [<font color="navy">java.util.Dictionary</font> parameters],
  [<font
color="navy">org.w3c.dom.Node</font> source]
)</pre>
  </blockquote>
  <p>Like in Javascript, these arguments are optional. The return type can be of any Java
  type including <i>void</i>. </p>
  <p>Java classes used as DCP objects need not implement/extend any particular interface or
  class. In the Cocoon environment, however, it is strongly recommended to extend class: </p>
  <blockquote>
    <code><p>org.apache.cocoon.dcp.ServletDCPProcessor</code>. </p>
  </blockquote>
  <p>This class provides the following convenience services: <ul>
    <li>Direct access to the servlet <font color="blue"><i>request</i></font> object </li>
    <li>Direct access to the <font color="blue"><i>document</i></font> being processed </li>
    <li>Factory methods to create all types of DOM nodes (elements, text nodes, document
      fragments, processing instructions, etc) </li>
  </ul>
  <p>If developers choose not to extend this convenience class, the following requirements
  must be honored: <ul>
    <li>The class must have an empty constructor </li>
    <li>The class must have at least one method that conforms to the above signature. </li>
  </ul>
  <p>In absence of a non-empty constructor, if the class does require initialization it can
  implement: </p>
  <blockquote>
    <code><i><p>org.cocoon.framework.Configurable</i></code>. </p>
  </blockquote>
  <p>In this case, the DCP processor will invoke the class' <code><i>init</i></code> method
  immediately after instantiation. The configuration values passed in this case are: <ul>
    <li>The <i>document</i> being processed </li>
    <li>The <i>parameters</i> passed to the processor by the invoking environment </li>
  </ul>
  <p>For the Cocoon environment, <i>parameters</i> contain: <ul>
    <li>The <code><font color="navy"><i>javax.servlet.http.HttpServletRequest</i> request</font></code>
      object corresponding to the current web server's request. </li>
    <li>The <code><font color="navy"><i>java.lang.String</i> path</font></code> associated with
      the current source XML document. </li>
    <li>The <code><font color="navy"><i>java.lang.String</i> browser</font></code> associated
      with the current request's <i>User-Agent</i> HTTP header. </li>
  </ul>
  <p>Based on the above, for our tutorial example, the corresponding Java class would be: </p>
  <pre>  <font color="darkMagenta">import</font> java.util.*;
  <font color="darkMagenta">import</font> java.text.*;
  <font
color="darkMagenta">import</font> org.w3c.dom.*;
  <font color="darkMagenta">import</font> javax.servlet.http.*;
  <font
color="darkMagenta">import</font> org.apache.cocoon.dcp.*;
  
  <font
color="darkGreen">public</font> <font color="darkGreen">class</font> Util <font
color="darkGreen">extends</font> ServletDCPProcessor {
    <font color="darkGreen">private</font> <font
color="darkGreen">static</font> <font color="darkGreen">int</font> count = 0;
  
    <font
color="darkGreen">public</font> <font color="darkGreen">synchronized</font> <font
color="darkGreen">int</font> getCount() {
      <font color="brown">return</font> ++count;
    } 
  
    <font
color="darkGreen">public</font> String getSystemDate(Dictionary parameters) {
      Date now = new Date();
      String formattedDate = now.toString();
      String format = (String) parameters.get(<font
color="magenta">&quot;format&quot;</font>);
  
      <font color="brown">if</font> (format != <font
color="magenta">null</font>) {
        <font color="brown">try</font> {
          SimpleDateFormat dateFormat = new SimpleDateFormat(format);
          formattedDate = dateFormat.format(now);
        } <font
color="brown">catch</font> (Exception e) { } <font color="blue">// Bad format, ignore and return default</font>
      }
  
      <font
color="brown">return</font> formattedDate;
    }
  
    <font color="darkGreen">public</font> Element getRequestParameters() {
      Enumeration e = <font
color="darkGreen">this</font>.request.getParameterNames();
  
      <font color="brown">if</font> (!e.hasMoreElements()) { <font
color="blue">// No parameters given, remove node from document </font>
        <font
color="brown">return</font> <font color="magenta">null</font>;
      }
  
      Element parameterList = createElement(<font
color="magenta">&quot;parameters&quot;</font>);
  
      <font color="darkGreen">int</font> count;
      Element parameterValue;
      Element parameterElement;
      <font
color="brown">for</font> (count = 0; e.hasMoreElements(); count++) {
        String name = (String) e.nextElement();
        String[] values = <font
color="darkGreen">this</font>.request.getParameterValues(name);
  
        parameterElement = createElement(<font
color="magenta">&quot;parameter&quot;</font>);
        parameterElement.setAttribute(<font
color="magenta">&quot;name&quot;</font>, name);
  
        <font color="brown">for</font> (<font
color="darkGreen">int</font> i = 0; i <values.length; i++) { parameterValue="createElement(&lt;font" color="magenta">&quot;parameter-value&quot;);
          parameterValue.appendChild(createTextNode(values[i]));
  
          parameterElement.appendChild(parameterValue);
        }
  
        parameterList.appendChild(parameterElement);
      }
  
      <font
color="brown">return</font> parameterList;
    }
  }  </pre>
</blockquote>

<h2>Known Problems</h2>

<ul>
  <li><b>Restricted Static Parameter Passing</b>. Due to the use of processing instructions as
      a means of inserting dynamic content in XML documents (as opposed to DOM <i>elements</i>),
      structured parameter passing can become too complex.</li>
</ul>

<blockquote>
 <p>Consider the case when an employee
      list must be dynamically generated. Using elements to pass parameters to node-generation
      methods would allow for such complex forms as: </p>
      <blockquote>
        <pre>  <font color="green">&lt;</font><font color="brown">employee-listing</font><font
color="green">&gt;</font>
    <font color="green">&lt;</font><font color="brown">database-connection</font><font
color="green">&gt;</font>
      <font color="green">&lt;</font><font color="brown">jdbc-driver</font><font
color="green">&gt;</font>oracle.jdbc.driver.OracleDriver<font color="green">&lt;</font><font
color="brown">/jdbc-driver</font><font color="green">&gt;</font>
      <font color="green">&lt;</font><font
color="brown">connect-url</font><font color="green">&gt;</font>jdbc:oracle:thin:@localhost:1521:orcl<font
color="green">&lt;</font><font color="brown">/connect-url</font><font color="green">&gt;</font>
      <font
color="green">&lt;</font><font color="brown">user-name</font><font color="green">&gt;</font> <font
color="green">&lt;</font><font color="brown">request-parameter</font> <font color="darkGreen">name</font>=<font
color="magenta">&quot;user&quot;</font>/<font color="green">&gt;</font> <font color="green">&lt;</font><font
color="brown">/user-name</font><font color="green">&gt;</font>
      <font color="green">&lt;</font><font
color="brown">password</font><font color="green">&gt;</font> <font color="green">&lt;</font><font
color="brown">request-parameter</font> <font color="darkGreen">name</font>=<font color="magenta">&quot;password&quot;</font>/<font
color="green">&gt;</font> <font color="green">&lt;</font><font color="brown">/password</font><font
color="green">&gt;</font>
    <font color="green">&lt;</font><font color="brown">/database-connection</font><font
color="green">&gt;</font>
    <font color="green">&lt;</font><font color="brown">selection-criteria</font><font
color="green">&gt;</font>
      <font color="green">&lt;</font><font color="brown">department-list</font><font
color="green">&gt;</font>
        <font color="green">&lt;</font><font color="brown">deptno</font><font
color="green">&gt;</font>10<font color="green">&lt;</font><font color="brown">/deptno</font><font
color="green">&gt;</font>
        <font color="green">&lt;</font><font color="brown">deptno</font><font
color="green">&gt;</font>30<font color="green">&lt;</font><font color="brown">/deptno</font><font
color="green">&gt;</font>
      <font color="green">&lt;</font><font color="brown">/department-list</font><font
color="green">&gt;</font>
    <font color="green">&lt;</font><font color="brown">/selection-criteria</font><font
color="green">&gt;</font>
  <font color="green">&lt;</font><font color="brown">/employee-listing</font><font
color="green">&gt;</font>        </pre>
      </blockquote>
      <p>An equivalent <font color="green">&lt;?</font><font color="brown">dcp-content</font><font
      color="green">?&gt;</font> parameter list, while possible, would be too long and,
      certainly, hard to read. </p>
      <p>Other nested, multivalued parameter forms simply cannot be expressed by means of
      single-valued processing instruction pseudo-attributes. </p>
      <p>A workaround for this is the traditional HTML idiom of using <i>hidden</i> fields in
      HTTP forms to pass static parameters. </p>
      <p>Important to note, XSP uses elements (instead of processing instructions) to specify
      dynamic content substitution. </p>
</blockquote>
<ul>
  <li><b>Javascript Performance</b>. While the current Javascript DCP performance is
      acceptable for small applications with light traffic, its response time is perceivably
      slower than that of Java.</li>
</ul>
<blockquote>
 <p>This is a natural consequence of Javascript being interpreted
      by Java (itself interpreted by the underlying VM). As such, this restriction may also
      apply to other scripting languages such as WebL. </p>
      <p>Sun has announced the future availability of a Java-based Javascript implementation
      that benefits from JIT compilation. </p>
      <p>Scott Ferguson's <a href="http://www.caucho.com">Resin</a> offers a JIT-based
      Javascript implementation. This option is being actively investigated, especially in the
      area of testing if Resin is as tightly integrated with Java as Fesi. </p>
      <p>In the meantime, some Fesi-based workarounds are being tested, most notably <i>evaluator
      pooling</i>, a technique based on dynamically cloning script evaluators when multiple,
      concurrent requests use the same Javascript external program. </p>
</blockquote>
<ul>
  <li><b>No Java Class Reloading</b>. While Javascript files are automatically reloaded when
      they change on disk, currently there is no provision for automatic Java class reloading.</li>
</ul>
<blockquote>
 <p>Implementing
      this feature requires a specialized class loader. Note that servlet engine-provided class
      reloading does not apply to DCP because external Java programs are <i>not</i> servlets
      but, rather, regular classes dynamically instantiated by the DCP driver instead of by the
      underlying servlet engine. <p/> </p>
      <p>The latter is also true if the user-supplied class extends DCP's convenience class </p>
      <blockquote>
        <i><code><p>org.apache.cocoon.dcp.ServletDCPProcessor</code></i>. </p>
      </blockquote>
</blockquote>

<h2>Real Life Example</h2>

<blockquote>
  <p>In addition to the examples presented in this document, there is a more complex
  application written entirely in Cocoon using Java DCP: the <a
  href="http://www.distributedsystems.com/cocoon/dcp/translator/">Cocoon Multilingual
  Dictionary</a>. </p>
  <p>This application lets users lookup terms and their translations in a number of European
  languages using Esperanto as the intermediate language. The entire example (source code
  and data, ~750K) can be downloaded from the above location. </p>
</blockquote>

<h2>Future Directions</h2>

<ul>
  <li>Some areas of the core DCP implementation may change as a result of the
    new Cocoon's caching mechanism and some hooks for changeable state
    evaluation might be added in the future. </li>
  <li>Development of dynamic content generation will move to the compiled pages
    side rather than on the interpreted pages side. For this reason, future
    development (and even survival) of the DCP processor cannot be estimated. </li>
</ul>

<p align="center"><font size="-1">Copyright (c) <a href="http://xml.apache.org">The Apache XML Project</a>.<br>
$Id: dcp.html,v 1.1.1.1 1999-11-09 01:51:29 stefano Exp $<br>
All rights reserved.</font></p>

</body>
</html>
