<html>
 <head>
 <meta HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
 <meta name="Author" content="Donald A. Ball Jr.">
 <title>Cocoon - SQLProcessor User Guide</title>
 </head>
 
<body bgcolor="#ffffff">
<p><img src="images/logo.gif" border="0"></p>

<h1 align="center">SQLProcessor
User Guide</h1><p align="center">by Donald Ball</p><h2>Description</h2><blockquote><p align="left">SQLProcessor is a processor for Cocoon that performs SQL queries, translates the
  result-set into an XML fragment, and inserts the fragment in the original document. I wrote it because I've got quite a bit of "legacy" data in SQL databases that I wanted to be able to easily access from Cocoon. I believe that servers and data structures capable of storing and retrieving large amounts of XML data natively will arise, obviating the need for this type of middleware. I also believe that it's going to take a while for them to achieve the same performance and stability we've come to expect from SQL databases, hence the current need for SQLProcessor or something like it.</p></blockquote><h2>Configuration</h2><blockquote><p align="left">Add this PI to the XML files to which you wish to add SQL queries:</p>
  <blockquote>
    <pre><font color="#0000FF">&lt;?cocoon-process type=&quot;sql&quot;?&gt;</font></pre>
  </blockquote>
  <p align="left">You probably want this before any "xslt" processing directives. Then add SQL connection information to your XML files. The tagset for connection
  definitions looks like this:</p>
  <blockquote>
    <pre><font color="#0000FF">&lt;connectiondefs&gt;
 &lt;connection name=&quot;foo_connection&quot;&gt;
  &lt;driver&gt;</font><font color="#008000">org.gjt.mm.mysql.Driver</font><font color="#0000FF">&lt;/driver&gt;
  &lt;dburl&gt;</font><font color="#008000">jdbc:mysql://mysql.example.com/foo_database</font><font color="#0000FF">&lt;/dburl&gt;
  &lt;username&gt;</font><font color="#008000">foo_user</font><font color="#0000FF">&lt;/username&gt;
  &lt;password&gt;</font><font color="#008000">foo_password</font><font color="#0000FF">&lt;/password&gt;
 &lt;/connection&gt;
 ... other connections if desired ...
&lt;/connectiondefs&gt;</font></pre>
  </blockquote>
  <p align="left">Username and password are optional. This tagset will be removed from the document after processing. Multiple connectiondefs should be processed properly, but there's no good reason I can think of to do that. It's probably desirable to put the connectiondefs in a standalone XML file and link it in with external entities. The syntax for that is:</p>
  <blockquote>
    <pre><font color="#0000FF">&lt;!DOCTYPE page [
 &lt;!ENTITY connection_defs SYSTEM &quot;http://www.example.com/cdefs.xml&quot;&gt;
]&gt;

&lt;page&gt;
 &amp;connection_defs;
 ... other XML data ...
&lt;/page&gt;</font></pre>
  </blockquote>
  <p align="left">but this has the significant disadvantage that your database usernames and passwords are by default accessible from the WWW. You may wish to protect the cdefs.xml file by restricting access to the directory it lives in to the ip address(es) of your server(s).</p><p align="left">The other warning here is that if cocoon is operating on the www.example.com site, it will try to process the cdefs.xml file before giving it to the XML parser. As long as cdefs.xml has no cocoon:process PI, you will not have any trouble but it will be somewhat slower than if cocoon is not involved. A simple trick to get around this is to rename the file to an extension that does not trigger cocoon. I use .sxml, shorthand for Source XML. Those of you with real operating systems can just make a link to the .xml file.</p><p align="left">In addition to the <i>connection</i> element, you can also have <i>querydefs</i> tags in your <i>connectiondefs</i> node. A <i>querydefs</i> node must have a unique name attribute. <i>query</i> tags (described below) may reference a <i>querydefs</i> tag in their defs attribute, which causes the <i>query</i> tag's attributes to default to the attributes of the <i>querydefs</i> tag. This is useful for setting commonly used groups of attributes. You may also specify a default <i>querydefs</i>. Here is an example:</p>
  <blockquote>
    <pre><font color="#0000FF">&lt;querydefs name=&quot;standard&quot; doc-element=&quot;options&quot; row-element=&quot;option&quot; connection=&quot;foo&quot;/&gt;
&lt;query defs=&quot;standard&quot;/&gt;</font></pre>
  </blockquote>
  <p align="left">is equivalent to</p>
  <blockquote>
    <pre><font color="#0000FF">&lt;query doc-element=&quot;options&quot; row-element=&quot;option&quot; connection=&quot;foo&quot;/&gt;</font></pre>
  </blockquote>
  <p align="left">You can also flag a <i>querydefs</i> node as the default for all <i>query</i> tags by setting the default attribute to yes. Note that <i>query</i> tags can always override the defaults.</p></blockquote><h2>Usage</h2><blockquote><p align="left">Add SQL queries to your XML files. The tagset looks like this:</p>
  <blockquote>
    <pre><font color="#0000FF">&lt;query connection=&quot;foo_connection&quot;&gt;
</font><font color="#008000"> select name,number,message from foo_table order by name
</font><font color="#0000FF">&lt;/query&gt;</font></pre>
  </blockquote>
  <p align="left">This will be replaced by a tagset that looks like this:</p>
  <blockquote>
    <pre><font color="#0000FF">&lt;ROWSET&gt;
 &lt;ROW ID=&quot;0&quot;&gt;
  &lt;NAME&gt;</font><font color="#008000">Donald Ball</font><font color="#0000FF">&lt;/NAME&gt;
  &lt;NUMBER&gt;</font><font color="#008000">23</font><font color="#0000FF">&lt;/NUMBER&gt;
  &lt;MESSAGE&gt;</font><font color="#008000">The Illuminati do not exist. This message paid for by the Illuminati.</font><font color="#0000FF">&lt;/MESSAGE&gt;
 &lt;/ROW&gt;
 ... other rows ...
&lt;/ROWSET&gt;</font></pre>
  </blockquote>
  <p align="left">You can also have SQLProcessor substitute values from the servlet request into your query. The syntax for that is:</p>
  <blockquote>
    <pre>&lt;query connection=&quot;foo_connection&quot;&gt;
 select name,number,message from foo_table where id={@id} order by name
&lt;/query&gt;</pre>
  </blockquote>
  <p align="left">This is, of course, highly configurable by setting attributes of the query tag. A partial list of attributes is:</p>
  <blockquote>
    <dl><dt><b>doc-element:</b></dt><dd>The tag with which to wrap the whole shebang. Default is ROWSET. If an empty string is specified, e.g. doc-element="", the whole shebang will not be wrapped.</dd><dt><b>row-element:</b></dt><dd>The tag with which to wrap each row. Default is ROW. Same deal as with doc-element.</dd><dt><b>tag-case:</b></dt><dd>The case in which to present the column name tags. Default is "preserve", meaning use whatever the JDBC driver likes to call the columns. Options are "upper" for forced uppercase (boo) or "lower" for forced lowercase (yay).</dd><dt><b>null-indicator:</b></dt><dd>What do we do with null columns. default is to not print anything for null columns, not even a column tag. If this is set to "y" or "yes", we add a NULL="YES" attribute to the column and put an empty string inside.</dd><dt><b>id-attribute:</b></dt><dd>What is the name of the attribute that uniquely identifies the rows? Default is ID. This is, of course, meaningless if row-element is set to an empty string.</dd><dt><b>id-attribute-column:</b></dt><dd>Which column should we use for the id attribute value (think primary key column). Default is to use the offset of this row in the query's resultset.</dd><dt><b>max-rows:</b></dt><dd>How many rows should we display</dd><dt><b>skip-rows:</b></dt><dd>How many rows should we skip before starting to display rows</dd><dt><b>variable-left-delimiter:</b></dt><dd>What string delimits variables in the query on the left side? Default is {@.</dd><dt><b>variable-right-delimiter:</b></dt><dd>What string delimits variables in the query on the right side? Default is }.</dd></dl>
  </blockquote>
</blockquote><h2>Creating Complex Queries</h2><blockquote><p align="left">URL request parameter substitution using {@var} is fine for many situations, but is inadequate for handling queries whose conditions are dependent on the state of many variables. To accomodate these queries, you can specify the name of a subclass of <b>SQLQueryCreator</b> that will create the query string. The method that should be overridden is:</p>
  <blockquote>
    <pre><font color="#0000FF">public String getQuery(Connection conn, String query, 
  Element query_element, Properties query_props, Dictionary parameters) throws Exception;</font></pre>
  </blockquote>
  <p align="left">This looks like a lot of parameters. I didn't figure that it made sense to deny any of the potential information available to the query creator. Just ignore what you don't care about. The parameters that deserve explanation are <b>query_props</b>, which is a Properties object containing all of the attribute values of the <i>query</i> tag, keyed by name. The <b>parameters</b> table is passed from cocoon to its processors, and contains lots of informatin, notable the original <b>HttpServletRequest</b>, keyed by the string "request".</p><p align="left">You specify the particular subclass of <b>SQLQueryCreator</b> in the <i>creator</i> attribute of the <i>query</i> tag. It's probably easiest if you put your query creators in a package, e.g. <b>com.webslingerZ.cocoon.ComplexQueryCreator</b>.</p><p align="left">One utility method is provided for your convenience. The SQLEscape method should parse a string for apostrophes and replace them with whichever string their database likes to use instead. It's not working correctly for my database drivers, so the default getQuery method does not use it. If anyone can suggest the correct way to go about doing this, please contact me with your suggestion or, ideally, a patch.</p><p align="left">This is probably an overly complex way to handle most complex queries. It is hopefully the case that a more sophisticated variable substitution scheme or alternate attribute set will arise that accomodates more common complex queries without the need to write Java code. There is also some rationale for making <b>SQLQueryCreator</b> an interface. I welcome suggestions along these lines.</p></blockquote><h2>Error Handling</h2><blockquote><p align="left">In a perfect world, nothing would ever go wrong in your queries but this is not a perfect world. In our world, you can check for SQLExceptions in your stylesheets and present them to your users in a nice way. The tags used to render the error are configurable using attributes from the <i>query</i> tag. The attributes in question are:</p>
  <blockquote>
    <dl><dt><b>error-element:</b></dt><dd>The name of the error-element to create, default is sqlerror.</dd><dt><b>error-message-attribute:</b></dt><dd>The name of the attribute of the error-element in which to put the Exception's message. Default is message.</dd><dt><b>error-message-element:</b></dt><dd>The name of the child element of the error-element in which to put the Exception's message. The default is to not do so.</dd><dt><b>error-stacktrace-attribute:</b></dt><dd>The name of the attribute of the error-element in which to put the Exception's stacktrace. The default is to not do so.</dd><dt><b>error-stacktrace-element:</b></dt><dd>The name of the child element of the error-element in which to put the Exception's stacktrace. The default is to not do so.</dd><dt><b>error-message-text:</b></dt><dd>The text to pass out as an error message instead of the Exception's own message. This is useful for displaying user friendly error messages. The default is to use the Exception's message.</dd></dl>
  </blockquote>
  <p align="left">So by default, when an SQLException occurs, the processor generates this XML:</p>
  <blockquote>
    <pre><font color="#0000FF">&lt;sqlerror message=&quot;The database server is on fire.&quot;/&gt;</font></pre>
  </blockquote>
</blockquote><h2>Notes and Disclaimers</h2><blockquote><p align="left">I sure hope this is useful to you. It's proving to be very useful to me. The DTD used here is a superset of that used by Oracle's XSQL servlet (which provides no methods for specifying alternate variable delimiters, creating complex queries, query default attributes, or error handling). <a href="http://technet.oracle.com/tech/xml/xsql_servlet/htdocs/relnotes.htm">Technical notes</a> for the XSQL servlet are available - note you apparantly must now fill out an annoying survey to get access to this page. We're sharing the DTD with the tacit approval of Steve Meunch, who kindly pointed me in that direction when he saw a) how similar our methodologies were and b) how horrible my original DTD was. Thanks also go out to Stefano
  Mazzocchi, who started this whole cocoon business in the first place, and Ricardo Rocha, whose DCP processor provided the framework for SQLProcessor's parent, XMLResultSet. Stefano Malimpensa has suggested many useful features that are beginning to make their way into the code.</p></blockquote><h2>Planned Features</h2><blockquote><ul><li>support for a &lt;querydefs&gt; tag for setting default query attributes</li><li>time-based caching of query results</li><li>simple postprocessing of SQL values (e.g. date formats)</li><li>error message display</li></ul></blockquote>
  
<p align="center"><font size="-1">Copyright (c) <a href="http://xml.apache.org">The Apache XML Project</a>.<br>
$Id: sqlprocessor.html,v 1.1.1.1 1999-11-09 01:51:29 stefano Exp $<br>
All rights reserved.</font></p>
</body>
</html>

