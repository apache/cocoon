<?xml version="1.0"?>
<!--
  Copyright 1999-2004 The Apache Software Foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<project name="validation">

  <description>
    Validation targets
  </description>

  <!-- Check if all the JAR files are properly declared in lib/jars.xml    -->
  <target name="validate-jars" depends="prepare" unless="exclude.validate.jars">
    <path id="all.jars">
      <fileset dir="${lib}">
        <include name="**/*.jar"/>
      </fileset>
    </path>

    <property name="all.jars" refid="all.jars"/>
    <copy file="${tools.src}/jars.xml.tmpl" 
          tofile="${build.temp}/current-jars.xml" 
          filtering="yes" overwrite="yes">
      <filterset>
        <filter token="JARS" value="${all.jars}"/>
      </filterset>
    </copy>

    <!-- split the path in 'jar' XML elements -->
    <replace file="${build.temp}/current-jars.xml"
             token="${path.separator}" 
             value="&lt;/jar&gt;&#xA; &lt;jar&gt;"/>

    <!-- relativize file names by removing the current directory -->
    <replace file="${build.temp}/current-jars.xml" 
             token="${user}${file.separator}lib${file.separator}" 
             value=""/>

    <!-- and incase that fails, remove the base directory -->
    <replace file="${build.temp}/current-jars.xml" 
             token="${basedir}${file.separator}lib${file.separator}" 
             value=""/>

    <!-- replace platform-dependent path separator by '/' -->
    <replace file="${build.temp}/current-jars.xml" 
             token="${file.separator}" 
             value="/"/>

    <xslt in="${lib}/jars.xml" out="${build.temp}/jars.xml"
          processor="trax"
          style="${tools}/src/check-jars.xsl">
      <param name="stylesheet-path" expression="${tools}/src"/>
      <param name="current-jars-path" expression="${build.temp}"/>
      <param name="current-jars-file" expression="current-jars.xml"/>
    </xslt>
  </target>

  <!-- Validate configuration files. -->
  <target name="validate-config" depends="prepare" unless="exclude.validate.config">
    <echo message="Validating configuration files"/>

    <echo message="Validating cocoon.xconf using a very basic RELAX NG grammar ..."/>
    <jing rngfile="${build.webapp}/WEB-INF/entities/any.rng">
      <fileset dir="${build.webapp}/WEB-INF" includes="cocoon.xconf"/>
    </jing>
  </target>

  <!-- Validation of xdocs  -->
  <target name="validate-xdocs" depends="prepare-docs" unless="exclude.validate.xdocs">
<!--
    <echo message="Conducting validation of core XML documentation."/>
-->
    <echo message="Not conducting validation of core XML documentation."/>
    <echo message="Use 'forrest validate-xdocs' instead."/>

<!-- FIXME: 
    <echo message="Validating all **/book.xml instances using RELAX NG ..."/>
    <jing rngfile="${webapp}/WEB-INF/entities/book-v01.rng">
      <fileset dir="${build.context}" includes="**/book.xml"/>
    </jing>
-->

<!--
    <echo message="Validating all xdocs/**/*.xml instances using DTDs ..."/>
    <xmlvalidate failonerror="true" lenient="no" warn="yes">
-->
      <!-- FIXME: we can use xmlcatalog/catalogpath with Ant-1.6 -->
<!--
      <xmlcatalog>
        <catalogpath>
          <pathelement location="${webapp}/WEB-INF/entities/catalog.xcat"/>
        </catalogpath>
      </xmlcatalog>
-->
<!--
      <fileset dir="${build.context}/xdocs" includes="**/*.xml"
               excludes="status.xml,drafts/*.xml,dictionary.xml,catalog-test.xml,ctwig/sample/**/*.xml,tabs.xml,dtd/**"/>
    </xmlvalidate>
-->

    <echo message="Validating the documentation sitemap.xmap using RELAX NG ..."/>
    <jing rngfile="${webapp}/WEB-INF/entities/sitemap-v06.rng">
      <fileset dir="${build.context}" includes="sitemap.xmap"/>
    </jing>

<!--    <echo message="Validating all documentation stylesheets using RELAX NG ..."/>
    <jing rngfile="${webapp}/WEB-INF/entities/xslt-20020523.rng">
      <fileset dir="${build.context}/stylesheets" includes="**/*.xsl"/>
    </jing>-->
  </target>
</project>