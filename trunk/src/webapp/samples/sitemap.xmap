<?xml version="1.0" encoding="UTF-8"?>

<!-- CVS $Id: sitemap.xmap,v 1.9 2003/03/26 21:21:37 stefano Exp $ -->

<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

<!-- =========================== Components ================================ -->

 <map:components>
  <map:generators default="file">
   <map:generator name="linkstatus" src="org.apache.cocoon.generation.LinkStatusGenerator"/>
  </map:generators>
  <map:transformers default="xslt"/>
  <map:readers default="resource"/>
  <map:serializers default="html"/>
  <map:matchers default="wildcard">
     <map:matcher logger="sitemap.matcher.header" name="filename" src="org.apache.cocoon.matching.modular.CachingRegexpMatcher">
        <input-module name="request-param">
           <parameter>filename</parameter>
        </input-module>
     </map:matcher>
  </map:matchers>
  <map:selectors default="browser"/>
 </map:components>

<!-- =========================== Views =================================== -->

 <map:views>
  <map:view name="content" from-label="content">
   <map:serialize type="xml"/>
  </map:view>

  <map:view name="pretty-content" from-label="data">
    <map:transform src="context://stylesheets/system/xml2html.xslt"/>
    <map:serialize type="html"/>
  </map:view>

  <map:view name="links" from-position="last">
   <map:serialize type="links"/>
  </map:view>
  
 </map:views>

<!-- =========================== Resources ================================= -->

 <map:resources>

  <map:resource name="dynamic-page">
     <map:generate src="{target}.xsp" type="serverpages"/>
     <map:transform src="context://samples/stylesheets/dynamic-page2html.xsl">
        <map:parameter name="servletPath" value="{request:servletPath}"/>
        <map:parameter name="sitemapURI" value="{request:sitemapURI}"/>
        <map:parameter name="contextPath" value="{request:contextPath}"/>
        <map:parameter name="file" value="{target}.xsp"/>
        <map:parameter name="remove" value="{remove}"/>
     </map:transform>
     <map:serialize/>
  </map:resource>

  <map:resource name="dynamic-page1">
     <!-- print all current sitemap parameters to log -->
     <map:act type="session-state">
        <map:parameter name="new-state" value="{../0}"/>
        <!-- 
           use the complete string that was matched as a parameter. Compare
           this with the target parameter below. There the third
           sitemap parameter refers to the very same string. Verfy this
           by looking at the log. This irritating effect stems from
           the fact, that the above map:parameter belongs conceptually
           still to the parent element while all other nested tags
           are, well, nested.
        -->
        <map:call resource="dynamic-page">
           <map:parameter name="target" value="{../target}/state{../../../0}{../../0}"/>
           <map:parameter name="remove" value="{../remove}"/>
        </map:call>
     </map:act>
  </map:resource>

  <map:resource name="dynamic-page2">
     <map:act type="session-state">
        <map:parameter name="new-state" value="1"/>
        <map:call resource="dynamic-page">
           <map:parameter name="target" value="{../target}1"/>
           <map:parameter name="remove" value="{../remove}"/>
        </map:call>
     </map:act>
  </map:resource>

  <map:resource name="simple-page">
     <map:generate src="{target}.xml" type="file"/>
     <map:transform src="context://samples/stylesheets/page/simple-page2html.xsl">
        <map:parameter name="servletPath" value="{request:servletPath}"/>
        <map:parameter name="sitemapURI" value="{request:sitemapURI}"/>
        <map:parameter name="contextPath" value="{request:contextPath}"/>
        <map:parameter name="file" value="{target}.xml"/>
        <map:parameter name="remove" value="{remove}"/>
     </map:transform>
     <map:serialize/>
  </map:resource>
 </map:resources>

<!-- =========================== Pipelines ================================= -->

 <map:pipelines>

  <map:pipeline>

   <map:match pattern="">
     <map:generate src="samples.xml"/>
     <map:transform src="context://samples/common/style/xsl/html/simple-samples2html.xsl">
        <map:parameter name="contextPath" value="{request:contextPath}"/>
     </map:transform>
     <map:serialize/>
   </map:match>

   <!-- =========================== Dynamic ================================ -->

   <map:match pattern="xsp/*">
    <map:generate src="docs/samples/xsp/{1}.xsp" type="serverpages"/>
    <map:transform src="context://samples/stylesheets/dynamic-page2html.xsl">
        <map:parameter name="servletPath" value="{request:servletPath}"/>
        <map:parameter name="sitemapURI" value="{request:sitemapURI}"/>
        <map:parameter name="contextPath" value="{request:contextPath}"/>
        <map:parameter name="file" value="docs/samples/xsp/{1}.xsp"/>
        <map:parameter name="remove" value="{0}"/>
    <!--
       Run-time configuration is done through these
       <map:parameter/> elements. Again, let's have a look at the
       javadocs: 

       "[...] All <map:parameter> declarations will be made
       available in the XSLT stylesheet as xsl:variables. [...]" 
    -->
    </map:transform>
    <map:serialize/>
   </map:match>

   <map:match pattern="xsp-plain/*">
    <map:generate src="docs/samples/xsp/{1}.xsp" type="serverpages"/>
    <map:serialize/>
   </map:match>

   <!-- ========================== Stream ================================= -->

   <map:match pattern="request1">
     <map:generate type="stream">
       <map:parameter name="form-name" value="Foo"/>
     </map:generate>
     <map:serialize type="xml"/>
   </map:match>

   <map:match pattern="Order">
     <map:generate src="docs/samples/stream/OrderPage.xml"/>
     <map:transform src="context://samples/stylesheets/dynamic-page2html.xsl">
        <map:parameter name="servletPath" value="{request:servletPath}"/>
        <map:parameter name="sitemapURI" value="{request:sitemapURI}"/>
        <map:parameter name="contextPath" value="{request:contextPath}"/>
        <map:parameter name="file" value=".xsp"/>
     </map:transform>
     <map:serialize type="html"/>
   </map:match>

   <!-- ========================= Other Samples ================================ -->

   <map:match pattern="scratchpad">
    <map:generate src="scratchpad-samples.xml"/>
    <map:transform src="context://samples/common/style/xsl/html/simple-samples2html.xsl">
       <map:parameter name="contextPath" value="{request:contextPath}"/>
    </map:transform>
    <map:serialize/>
   </map:match>

   <map:match pattern="blocks">
    <map:generate src="block-samples.xml"/>
    <map:transform src="context://samples/common/style/xsl/html/simple-samples2html.xsl">
       <map:parameter name="contextPath" value="{request:contextPath}"/>
    </map:transform>
    <map:serialize/>
   </map:match>

   <!-- ========================= Utilities ================================ -->

   <map:match pattern="view-source">
    <!-- colourize files that are known to be XML -->
    <map:match type="filename" pattern="((xml)|(xsp)|(xmap)|(xconf))$">
       <map:generate src="common/view-source.xsp" type="serverpages"/>
       <map:serialize/>
    </map:match>
    <!-- all other files are just send as text -->
    <map:read mime-type="text/plain" src="../{request-param:filename}"/>
   </map:match>

   <map:match pattern="linkstatus">
     <map:redirect-to uri="linkstatus/localhost/8888/docs/index.html"/>
   </map:match>

   <map:match pattern="linkstatus/*/*/**">
     <map:generate type="linkstatus" src="http://{1}:{2}/{3}"/>
     <map:transform src="context://stylesheets/system/linkstatus2html.xslt"/>
     <map:serialize/>
   </map:match>
   
   <map:match pattern="status.html">
    <map:generate src="status" type="status"/>
    <map:transform src="context://stylesheets/system/status2html.xslt"/>
    <map:serialize/>
   </map:match>

   <map:match pattern="clearcache.html">
    <map:act type="clear-cache">
     <map:generate src="status" type="status"/>
     <map:transform src="context://stylesheets/system/status2html.xslt"/>
     <map:serialize/>
    </map:act>
   </map:match>

   <map:match pattern="clearpersistentstore.html">
    <map:act type="clear-persistent-store">
     <map:generate src="status" type="status"/>
     <map:transform src="context://stylesheets/system/status2html.xslt"/>
     <map:serialize/>
    </map:act>
   </map:match>

   <map:match pattern="request.html">
    <map:generate type="request"/>
    <map:transform src="context://stylesheets/system/xml2html.xslt"/>
    <map:serialize/>
   </map:match>

   <map:match pattern="generror.html">
    <map:generate src="error-giving-page.xml"/>
    <map:serialize/>
   </map:match>
  
   <!-- ======================== Automount =============================== -->
   
   <map:match pattern="*/**">
     <map:mount uri-prefix="{1}" src="{1}/" check-reload="yes"/>
   </map:match>
  
  </map:pipeline>
  
 </map:pipelines>

</map:sitemap>
