<?xml version="1.0"?>

<!--
  CVS $Id: sitemap.xmap,v 1.1 2003/10/14 16:40:08 haul Exp $

  Event Cache Sample
-->

<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
  <map:components>
    <map:generators default="file"/>
    <map:transformers default="xslt"/>
    <map:readers default="resource"/>
    <map:serializers default="html"/>
    <map:matchers default="wildcard">
        <map:matcher name="host-matcher"
                     logger="sitemap.matcher.wildcard"
                     src="org.apache.cocoon.matching.modular.CachingWildcardMatcher">
            <input-module name="request"/>
            <parameter-name>serverName</parameter-name>
        </map:matcher>
    </map:matchers>
    <map:selectors default="browser"/>
    <map:actions>
    	<map:action name="cacheevent" src="org.apache.cocoon.acting.CacheEventAction"/>
    	<map:action name="jmsevent" src="org.apache.cocoon.components.jms.JMSPublisherAction">
          <parameter name="connection" value="OpenJMS-demo"/>
        </map:action>
    </map:actions>

    <map:pipes default="caching">
	  <!-- A pipe must be defined configured to use the EventAware cache. -->
      <map:pipe name="event-aware" src="org.apache.cocoon.components.pipeline.impl.CachingProcessingPipeline">
        <parameter name="cache-role" value="org.apache.cocoon.caching.Cache/EventAware"/>
      </map:pipe>
    </map:pipes>
  </map:components>

  <map:views>
    <map:view from-label="content" name="content">
      <map:serialize type="xml"/>
    </map:view>
  </map:views>

  <map:pipelines>

    <!-- Our content must occur in a pipeline configured to use our Event Aware cache -->
    <map:pipeline type="event-aware">
      <map:match pattern="eventcache">
        <map:generate type="serverpages" src="{0}.xsp"/>
	    <map:transform src="context://samples/stylesheets/dynamic-page2html.xsl">
	        <map:parameter name="servletPath" value="{request:servletPath}"/>
	        <map:parameter name="sitemapURI" value="{request:sitemapURI}"/>
	        <map:parameter name="contextPath" value="{request:contextPath}"/>
	        <map:parameter name="file" value="{0}.xsp"/>
	        <map:parameter name="remove" value="{0}"/>
	    </map:transform>
        <map:serialize/>
      </map:match>
    </map:pipeline>

    <map:pipeline>

      <map:match pattern="">
        <map:redirect-to uri="eventcache"/>
      </map:match>

	  <map:match pattern="invalidate">
        <map:match type="host-matcher" pattern="localhost">
            <map:act type="cacheevent">
                <map:parameter name="event" value="{request-param:table}"/>
            </map:act>
            <map:read src="invalidated.xml"/>
        </map:match>
        <map:read src="access-error.xml"/>
	  </map:match>

	  <map:match pattern="jms-invalidate">
        <map:match type="host-matcher" pattern="localhost">
            <map:act type="jmsevent">
                <map:parameter name="event" value="action|{request-param:table}"/>
            </map:act>
            <map:read src="invalidated.xml"/>
        </map:match>
        <map:read src="access-error.xml"/>
	  </map:match>

      <map:match pattern="*">
        <map:generate type="serverpages" src="{1}.xsp"/>
	    <map:transform src="context://samples/stylesheets/dynamic-page2html.xsl">
	        <map:parameter name="servletPath" value="{request:servletPath}"/>
	        <map:parameter name="sitemapURI" value="{request:sitemapURI}"/>
	        <map:parameter name="contextPath" value="{request:contextPath}"/>
	        <map:parameter name="file" value="{1}.xsp"/>
	        <map:parameter name="remove" value="{0}"/>
	    </map:transform>
        <map:serialize/>
      </map:match>
    </map:pipeline>

  </map:pipelines>
</map:sitemap>

