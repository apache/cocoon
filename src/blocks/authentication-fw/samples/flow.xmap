<?xml version="1.0"?>

<!--+
    | Authentication (with flow) block samples sitemap.
    |
    | CVS $Id: flow.xmap,v 1.1 2003/09/17 08:44:49 upayavira Exp $
    +-->

<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

  <map:components>
    <map:transformers default="xslt">
      <map:transformer name="jxpath" src="org.apache.cocoon.transformation.JXTemplateTransformer" logger="jxpath.sitemap.transformer"/>
    </map:transformers>
  </map:components>

  <map:flow language="javascript">
     <map:script src="flow/sample.js"/>
  </map:flow>

<!-- =========================== Pipelines ================================= -->
  <map:pipelines>
    <map:component-configurations>
      <authentication-manager>
        <handlers>
          <handler name="flowdemohandler">
            <redirect-to uri="cocoon:/login"/>
            <authentication uri="cocoon:raw:/authenticate"/>
          </handler>
        </handlers>
      </authentication-manager>
    </map:component-configurations>

    <map:pipeline>
      <map:match pattern="">
        <map:redirect-to uri="login" session="true"/>
      </map:match>

      <!-- ================= -->
      <!-- Simple login page -->
      <!-- ================= -->
      <map:match pattern="login">
        <!-- if we are already logged in, redirect to the protected document -->
        <map:call function="protect">
          <map:parameter name="handler" value="flowdemohandler"/>
          <map:parameter name="failure-internal" value="internal/login"/>
          <map:parameter name="protected-internal" value="protected"/>
        </map:call>
      </map:match>

      <!-- ========================================= -->
      <!-- Form target which performs auth service   -->
      <!-- ========================================= -->
      <map:match pattern="do-login">
        <!-- try to login -->
        <map:call function="login">
          <map:parameter name="handler" value="flowdemohandler"/>
          <map:parameter name="name" value="{request-param:username}"/>
          <map:parameter name="protected-internal" value="protected"/>
          <map:parameter name="failure-internal" value="login"/>
        </map:call>
      </map:match>

      <!-- ================ -->
      <!-- Protected area   -->
      <!-- ================ -->
      <map:match pattern="protected">
        <map:call function="protect">
          <map:parameter name="handler" value="flowdemohandler"/>
          <map:parameter name="protected-internal" value="internal/protected"/>
          <map:parameter name="failure-internal" value="login"/>
        </map:call>
      </map:match>

      <!-- ========================================= -->
      <!-- Logout link which invalidates the session -->
      <!-- ========================================= -->
      <map:match pattern="do-logout">
        <map:call function="logout">
          <map:parameter name="handler" value="flowdemohandler"/>
          <map:parameter name="failure-internal" value="login"/>
        </map:call>
      </map:match>
    </map:pipeline>

    <map:pipeline internal-only="true">
      <!-- This is the authentication respource -->
      <map:match pattern="authenticate">
        <map:generate src="docs/userlist.xml"/>
        <map:transform src="stylesheets/authenticate.xsl">
          <map:parameter name="use-request-parameters" value="true"/>
        </map:transform>
        <map:serialize type="xml"/>
      </map:match>
    </map:pipeline>

    <map:pipeline internal-only="true">
      <map:match pattern="internal/login">
        <map:generate src="docs/login.xml"/>
        <map:transform src="stylesheets/simple-page2html.xsl"/>
        <map:transform type="encodeURL"/>
        <map:serialize/>
      </map:match>
      
      <map:match pattern="internal/protected">
        <map:generate src="docs/protected.xml"/>
        <map:transform type="session"/>
        <map:transform src="stylesheets/simple-page2html.xsl"/>
        <map:transform type="encodeURL"/>
        <map:serialize/>
      </map:match>
    </map:pipeline>  

  </map:pipelines>
</map:sitemap>
