<?xml version="1.0"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

<map:components>
  <map:generators default="file">
    <map:generator name="traverse" src="org.apache.cocoon.generation.TraversableGenerator"/>
  </map:generators>
</map:components>

<map:pipelines>

  <map:component-configurations>
    <global-variables>
      <staging></staging>
      <!--staging>webdav://localhost/webdav/step5/</staging-->
    </global-variables>
  </map:component-configurations>

  <map:pipeline>

    <map:match pattern="repo/">
      <map:generate type="traverse" src="{global:staging}repo/">
        <map:parameter name="exclude" value="[\w]*.meta"/>
      </map:generate>
      <map:transform src="{global:staging}styles/dir2html.xsl"/>
      <map:serialize type="html"/>
    </map:match>

    <map:match pattern="repo/**/">
      <map:generate type="traverse" src="{global:staging}repo/{1}/">
        <map:parameter name="exclude" value="[\w]*.meta"/>
      </map:generate>
      <map:transform src="{global:staging}styles/dir2html.xsl"/>
      <map:serialize type="html"/>
    </map:match>

    <map:match pattern="**/new">
        <map:generate src="{global:staging}new.xml"/>
        <map:transform src="{global:staging}styles/new2html.xsl">
          <map:parameter name="file" value="{1}/new"/>
          <map:parameter name="requestURI" value="{request:requestURI}"/>
          <map:parameter name="sitemapURI" value="{request:sitemapURI}"/>
        </map:transform>
        <map:serialize type="html"/>
    </map:match>

    <map:match pattern="repo/**">
        <map:aggregate element="page">
          <map:part src="cocoon:/page/{1}"/>
          <map:part src="cocoon:/metapage/{1}"/>
        </map:aggregate>
        <map:transform src="{global:staging}styles/file2html.xsl">
          <map:parameter name="file" value="repo/{1}"/>
          <map:parameter name="requestURI" value="{request:requestURI}"/>
          <map:parameter name="sitemapURI" value="{request:sitemapURI}"/>
        </map:transform>
        <map:serialize type="html"/>
    </map:match>
    <map:match pattern="page/**">
        <map:generate src="{global:staging}repo/{1}"/>
        <map:serialize type="xml"/>
    </map:match>
    <map:match pattern="metapage/**">
        <map:generate src="{global:staging}repo/{1}.meta"/>
        <map:serialize type="xml"/>
    </map:match>

    <map:match pattern="write/**">
        <map:generate type="request"/>
        <map:transform src="{global:staging}styles/request2doc.xsl"/>
        <map:transform src="{global:staging}styles/doc2write.xsl">
          <map:parameter name="file" value="{global:staging}{1}"/>
        </map:transform>
        <map:transform type="write-source"/>
        <map:serialize type="xml"/>
    </map:match>

  </map:pipeline>
</map:pipelines>

</map:sitemap>
