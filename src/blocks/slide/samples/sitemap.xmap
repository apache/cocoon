<?xml version="1.0"?>

<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

<!-- =========================== Components =================================== -->

 <map:components>
  <map:generators default="file">
   <map:generator name="traverse" 
                  src="org.apache.cocoon.generation.TraversableSourceDescriptionGenerator" 
                  logger="sitemap.generator.traverse"
                  label="content"/>
   <map:generator name="principallist"
                  src="org.apache.cocoon.generation.PrincipalListGenerator"
                  logger="sitemap.generator.principallist"
                  label="content"/>
  </map:generators>

  <map:transformers default="xslt"/>
  <map:readers default="resource"/>
  <map:serializers default="html"/>
  <map:matchers default="wildcard"/>
  <map:selectors default="browser"/>

  <map:actions>
   <map:action name="auth-protect" logger="sitemap.action.auth-protect" 
               src="org.apache.cocoon.webapps.authentication.acting.AuthAction"/>
   <map:action name="auth-login" logger="sitemap.action.auth-login"
               src="org.apache.cocoon.webapps.authentication.acting.LoginAction"/>
   <map:action name="auth-logout" logger="sitemap.action.auth-logout"
               src="org.apache.cocoon.webapps.authentication.acting.LogoutAction"/>
   <map:action name="auth-loggedIn" logger="sitemap.action.auth-loggedIn"
               src="org.apache.cocoon.webapps.authentication.acting.LoggedInAction"/>
  </map:actions>
 </map:components>

<!-- ========================== Flowscript ================================= -->

  <map:flow language="javascript">
    <map:script src="flow.js"/>
  </map:flow>
  
<!-- =========================== Views =================================== -->

 <map:views>
  <map:view name="content" from-label="content">
   <map:serialize type="xml"/>
  </map:view>
  <map:view from-label="content" name="pretty-content">
   <map:transform src="context://stylesheets/system/xml2html.xslt"/>
   <map:serialize type="html"/>
  </map:view>
 </map:views>


<!-- =========================== Pipelines ================================= -->

 <map:pipelines>
  <map:component-configurations>
   <authentication-manager>
    <handlers>
     <handler name="slidehandler" xmlns:map="http://apache.org/cocoon/sitemap/1.0">
      <redirect-to    uri="cocoon://slide-samples/login.html"/>
      <authentication uri="cocoon:/authenticate"/>
     </handler>
    </handlers>
   </authentication-manager>
   <global-variables>
     <namespace>cocoon</namespace>
   </global-variables>
  </map:component-configurations>


  <map:pipeline internal-only="false" type="noncaching">
   <map:match pattern="principallist">
    <map:generate type="principallist">
     <map:parameter name="principalprovider" value="slide"/>
     <map:parameter name="principalcaller" value="root"/>
    </map:generate>
    <map:serialize type="xml"/>
   </map:match>

   <map:match pattern="authenticate">
     <map:call function="authenticate" />
   </map:match>

   <map:match pattern="authentication">
    <map:generate type="jx" src="screens/authentication.jx" />
    <map:serialize type="xml"/>
   </map:match>
   
   <!-- =============  Source description ============= -->
   <map:match pattern="description/*/**">
    <map:generate type="traverse" src="slide://{1}@{global:namespace}/{2}">
     <map:parameter name="properties" value="true"/>
     <map:parameter name="permissions" value="false"/>
     <map:parameter name="locks" value="true"/>
     <map:parameter name="version" value="false"/>
     <map:parameter name="depth" value="1"/>
    </map:generate>
    <map:serialize type="xml"/>
   </map:match>
  </map:pipeline>


  <map:pipeline>
   <map:match pattern="">
    <map:redirect-to uri="content/"/>
   </map:match>
 
   <map:match pattern="login.html">
    <map:generate src="screens/login.xml"/>
    <map:transform src="context://samples/common/style/xsl/html/complex-page2html.xsl">
     <map:parameter name="contextPath" value="{request:contextPath}"/>
    </map:transform>
    <map:serialize/>
   </map:match>

   <map:match pattern="login">
    <map:act type="auth-login">
     <map:parameter name="handler" value="slidehandler"/>
     <map:parameter name="parameter_name" value="{request-param:userid}"/>
     <map:parameter name="parameter_password" value="{request-param:password}"/>
     <map:redirect-to uri="{request-param:resource}"/>
    </map:act>

    <map:generate src="login-failed.xml"/>
    <map:transform src="context://samples/common/style/xsl/html/complex-page2html.xsl">
     <map:parameter name="contextPath" value="{request:contextPath}"/>
    </map:transform>
    <map:serialize/>
   </map:match>

   <map:match pattern="logout.html">
    <map:act type="auth-logout">
     <map:parameter name="handler" value="slidehandler"/>

     <map:generate src="screens/logout.xml"/>
      <map:transform src="context://samples/common/style/xsl/html/complex-page2html.xsl">
       <map:parameter name="contextPath" value="{request:contextPath}"/>
      </map:transform>
     <map:serialize/>
    </map:act>

    <map:redirect-to uri="login.html"/>
   </map:match>

   <map:match pattern="**">
    <map:act type="auth-protect">
     <map:parameter name="handler" value="slidehandler"/>
     
     <map:match pattern="*.do">
       <map:call function="public_{1}">
         <map:parameter name="caller"    value="{../ID}" />
         <map:parameter name="namespace" value="{global:namespace}" />
       </map:call>
     </map:match>

     <!-- ============= Source content ================== -->

     <map:match pattern="content/**">
      <map:generate src="cocoon:/description/{../ID}/{1}"/>
      <map:transform src="styles/description2html4content.xsl">
       <map:parameter name="path" value="{1}" />
       <map:parameter name="namespace" value="{global:namespace}" />
       <map:parameter name="principal" value="{../ID}"/>
      </map:transform>
      <map:transform src="context://samples/common/style/xsl/html/complex-page2html.xsl">
       <map:parameter name="contextPath" value="{request:contextPath}"/>
      </map:transform>
      <map:transform type="xinclude"/>
      <map:serialize type="html"/>
     </map:match>

     <!-- ============= Source properties =============== -->
     <map:match pattern="properties/**">
      <map:generate src="cocoon:/description/{../ID}/{1}"/>
      <map:transform src="styles/description2html4properties.xsl"/>
      <map:transform src="context://samples/common/style/xsl/html/complex-page2html.xsl">
       <map:parameter name="contextPath" value="{request:contextPath}"/>
      </map:transform>
      <map:serialize type="html"/>
     </map:match>

     <!-- ============= Source permissions ============== -->
     <map:match pattern="permissions/**">
     
      <map:aggregate element="document">
       <map:part src="cocoon:/description/{../ID}/{1}"/>
       <map:part src="cocoon:/principallist"/>
      </map:aggregate>

      <map:transform src="styles/description2html4permissions.xsl"/>
      <map:transform src="context://samples/common/style/xsl/html/complex-page2html.xsl">
       <map:parameter name="contextPath" value="{request:contextPath}"/>
      </map:transform>
      <map:serialize type="html"/>
     </map:match>

     <!-- ============= Source locks ==================== -->
     <map:match pattern="locks/**">
      <map:generate src="cocoon:/description/{../ID}/{1}"/>
      <map:transform src="styles/description2html4locks.xsl">
       <map:parameter name="path" value="{1}" />
      </map:transform>
      <map:transform src="context://samples/common/style/xsl/html/complex-page2html.xsl">
       <map:parameter name="contextPath" value="{request:contextPath}"/>
      </map:transform>
      <map:serialize type="html"/>
     </map:match>

     <!-- ============= Repository users =============== -->
     <map:match pattern="users/**">
      <map:generate type="principallist">
       <map:parameter name="principalprovider" value="slide"/>
       <map:parameter name="principalcaller" value="{../ID}"/>
      </map:generate>
      <map:transform src="styles/principal2html4users.xsl">
       <map:parameter name="contextPath" value="{request:contextPath}"/>
      </map:transform>
      <map:transform src="context://samples/common/style/xsl/html/complex-page2html.xsl">
       <map:parameter name="contextPath" value="{request:contextPath}"/>
      </map:transform>
      <map:serialize type="html"/>
     </map:match>

    </map:act>
   </map:match>
			
  </map:pipeline>
 </map:pipelines>
</map:sitemap>
