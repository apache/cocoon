<!-- An implementation of the CForms template engine as a JXTemplate tag library -->
	
<jx:template xmlns:jx="http://apache.org/cocoon/templates/jx/1.0"
             xmlns:fi="http://apache.org/cocoon/forms/1.0#instance">
    <!--
        ft:form-template
    -->
	<jx:macro name="form-template" targetNamespace="http://apache.org/cocoon/forms/1.0#template">
    <jx:set var="cformsHelper" value="#{org.apache.cocoon.forms.generation.JXMacrosHelper.createHelper($cocoon/consumer)}"/>
	  <jx:set var="cformsDummy" value="${cformsHelper.startForm(macro.arguments)}"/>
        <jx:set var="form" value="${CocoonFormsInstance}"/>
        <!-- the form is also the current widget -->
        <jx:set var="widget" value="${form}"/>
        <jx:evalBody/>
      <jx:set var="cformsDummy" value="${cformsHelper.endForm()}"/>
	</jx:macro>
	
    <!--
        ft:widget
    -->
	<jx:macro name="widget" targetNamespace="http://apache.org/cocoon/forms/1.0#template">
	  <jx:parameter name="id"/>
      
	  <jx:set var="widget" value="${cformsHelper.getWidget(widget, id)}"/>
      <jx:set var="cformsDummy" value="${cformsHelper.generateWidget(widget, locale)}"/>
	  <jx:evalBody/>
      <jx:set var="cformsDummy" value="${cformsHelper.flushRoot(widget)}"/>
    </jx:macro>
	
    <!--
        ft:repeater-widget-label
    -->
	<jx:macro name="repeater-widget-label" targetNamespace="http://apache.org/cocoon/forms/1.0#template">
	  <jx:parameter name="id"/>
	  <jx:parameter name="widget-id"/>
      
	  <jx:set var="cformsDummy" value="${cformsHelper.generateRepeaterWidgetLabel(widget, id, this['widget-id'])}"/>
	</jx:macro>
	
    <!--
        ft:widget-label
    -->
	<jx:macro name="widget-label" targetNamespace="http://apache.org/cocoon/forms/1.0#template">
	  <jx:parameter name="id"/>
      
	  <jx:set var="cformsDummy" value="${cformsHelper.generateWidgetLabel(widget, id)}"/>
	</jx:macro>
	
    <!--
        ft:repeater-size
    -->
	<jx:macro name="repeater-size" targetNamespace="http://apache.org/cocoon/forms/1.0#template">
	  <jx:parameter name="id"/>
      
	  <jx:set var="cformsDummy" value="${cformsHelper.generateRepeaterSize(widget, id)}"/>
	</jx:macro>
	
    <!--
        ft:repeater-widget
    -->
	<jx:macro name="repeater-widget" targetNamespace="http://apache.org/cocoon/forms/1.0#template">
	  <jx:parameter name="id"/>
	
	  <jx:set var="repeater" value="${cformsHelper.getRepeater(widget, id)}"/>
	  <jx:forEach varStatus="repeaterLoop" begin="0" end="${repeater.getSize() - 1}">
		  <jx:set var="widget" value="${repeater.getRow(repeaterLoop.index)}"/> 
		  <jx:evalBody/>
	  </jx:forEach>
	</jx:macro>
	
    <!--
        ft:continuation-id
    -->
	<jx:macro name="continuation-id" targetNamespace="http://apache.org/cocoon/forms/1.0#template">
	  <fi:continuation-id>${cocoon.continuation.id}</fi:continuation-id>
	</jx:macro>

    <!--
        ft:class
    -->
    <jx:macro name="class" targetNamespace="http://apache.org/cocoon/forms/1.0#template">
      <jx:parameter name="id"/>
      
	  <jx:set var="cformsDummy" value="${cformsHelper.defineClassBody(form, id, macro.body)}"/>
    </jx:macro>

    <!--
        ft:new
    -->
    <jx:macro name="new" targetNamespace="http://apache.org/cocoon/forms/1.0#template">
      <jx:parameter name="id"/>
      
      <jx:eval select="${cformsHelper.getClassBody(id)}"/>
    </jx:macro>

    <!--
        ft:struct : just increase the nesting level
    -->
	<jx:macro name="struct" targetNamespace="http://apache.org/cocoon/forms/1.0#template">
	  <jx:parameter name="id"/>
      
      <jx:set var="widget" value="${cformsHelper.getWidget(widget, id)}"/>
      <fi:struct id="${widget.getRequestParameterName()}">
        <jx:evalBody/>
      </fi:struct>
    </jx:macro>
    
    <!--
        ft:union
    -->
    <jx:macro name="union" targetNamespace="http://apache.org/cocoon/forms/1.0#template">
      <jx:parameter name="id"/>
	  
      <jx:set var="widget" value="${cformsHelper.getWidget(widget, id)}"/>
      <fi:union id="${widget.getRequestParameterName()}">
        <jx:evalBody/>
      </fi:union>
    </jx:macro>

    <!--
        ft:case
    -->
    <jx:macro name="case" targetNamespace="http://apache.org/cocoon/forms/1.0#template">
      <jx:parameter name="id"/>

      <jx:if test="${cformsHelper.isSelectedCase(widget, id)}">
		<jx:set widget="${cformsHelper.getWidget(widget, id)}"/>
        <jx:evalBody/>
      </jx:if>
    </jx:macro>
    
    <!--
        ft:validation-error
    -->
    <jx:macro name="validation-error" targetNamespace="http://apache.org/cocoon/forms/1.0#template">
      <jx:parameter name="id"/>
      
      <jx:set var="widget" value="${cformsHelper.getWidget(widget, id)}"/>
      <jx:set var="validationError" value="${widget.getValidationError()}"/>
      <jx:if test="${cformsHelper.isValidationError(validationError)}">
        <jx:set var="cformsDummy" value="${cformsHelper.generateValidationError(validationError)}"/>
          <jx:evalBody/>
        <jx:set var="cformsDummy" value="${cformsHelper.flushRoot(validationError)}"/>
      </jx:if>
    </jx:macro>


    <!--
        ft:aggregate-widget : TODO
    -->
    
</jx:template>
