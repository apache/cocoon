<?xml version="1.0"?>
<!--
  Copyright 1999-2004 The Apache Software Foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<!DOCTYPE document PUBLIC "-//APACHE//DTD Documentation V1.0//EN" "document-v10.dtd">

<document>
 <header>
  <title>How to Publish XML Documents in HTML and PDF</title>
  <authors>
   <person name="Bertrand Delacr&#233;taz" email="bdelacretaz@codeconsult.ch"/>
  </authors>
 </header>

 <body>

<s1 title="Overview">
<p>
This How-To shows you how to publish XML documents in HTML and PDF using Cocoon. It requires no 
prior knowledge of Cocoon, XSLT or XSL-FO.
</p>
<p>
It has been updated for Cocoon 2.1, which does not require the use of the <em>mount</em> directory anymore.
</p>
</s1>

<s1 title="Purpose">
<p>
You will learn how to build a simple pipeline that converts XML documents on-the-fly to HTML or PDF using simple 
XSLT transforms. This is similar to the <code>hello.html</code> and <code>hello.pdf</code> samples of the standard Cocoon installation. However, this How-To teaches you how to build these mechanisms yourself. Thus, you will get a better feel of how Cocoon publishing really works.
</p>
</s1>

<s1 title="Intended Audience">
<p>
Beginning Cocoon users who want to learn how to publish HTML and/or PDF documents from XML data.
</p>
</s1>

<s1 title="Prerequisites">
<p>Here's what you need:</p>  

<ul>
<li>Cocoon must be running on your system. The steps below have been tested with Cocoon 2.1m3-dev, but they should work with any 2.1 version.</li>
<li>This document assumes a standard installation where Cocoon is started by the <em>cocoon.sh</em> (or cocoon.bat) script and where
<code>http://localhost:8888/</code> points to the <em>Welcome to Apache Cocoon</em> page.
<br />
If your installation runs on a different URL, you will have to adjust
the URLs provided throughout this How-To as necessary. 
</li>
<li>You must be able to create and edit XML files in the main directory of the Cocoon installation.
When started from cocoon.sh, this directory is <code>build/webapp</code> under the directory that contains cocoon.sh.
</li>
</ul>
<note>You will not need a fancy XML editor for this How-To. Copying and pasting the sample code snippets into any text editor
will do.</note>
<note>
Running "build clean" deletes everything under build/webapp, make sure to save your example files if you
need to do a clean build.
 </note>

</s1>

<s1 title="Steps">
<p>
Here's how to proceed.
</p>

<s2 title="1. Create the work directory" >
<p>
Under <code>build/webapp</code>, create a new directory and name it <code>html-pdf</code>.
All files used by this How-To will reside in this directory.
</p>
<p>
At this point, <code>http://localhost:8888/html-pdf/</code> should display an error page saying <em>Resource not found</em>,
indicating that the file <em>build/webapp/html-pdf/sitemap.xmap</em> was not found. This is normal, as the newly
created directory does not yet contain the required sitemap file.
</p>
</s2>

<s2 title="2. Create the XML example documents" >
<p>
To keep it simple we will use two small XML files as our data sources.
Later, you will probably use additional data sources like live XML feeds, databases, and others.</p>
<p>
In the <code>html-pdf</code> directory, create the following two files, and name them exactly as
shown.
</p>

<p>
Contents of file <strong>pageOne.xml</strong>:
</p>
       <source><![CDATA[
<?xml version="1.0" encoding="iso-8859-1"?>
<page>
<title>This is the pageOne.xml example</title>
<s1 title="Section one">
    <p>This is the text of section one</p>
</s1>
</page>
        ]]></source>

<p>
Contents of file <strong>pageTwo.xml</strong>:
</p>
       <source><![CDATA[
<?xml version="1.0" encoding="iso-8859-1"?>
<page>
<title>This is the pageTwo.xml example</title>
<s1 title="Yes, it works">
    <p>Now you're hopefully seeing pageTwo in HTML or PDF</p>
</s1>
</page>
        ]]></source>
        
<note>
Be careful about the use of lower/uppercase in filenames if you're working on a Unix or Linux system. 
On such systems, <code>thisFile.xml</code> is not the same as <code>Thisfile.xml</code>.
</note>
<note>
To avoid any errors, use copy/paste when creating XML documents from examples on this page.
</note>
<note>
Do not leave spaces at the start of XML files. The &lt;?xml... processing instruction must
be the first character in the file.
</note>
</s2>

<s2 title="3. Create the XSLT transform for HTML" >
<p>
The most common way of producing HTML in Cocoon is to use <strong>XSLT transforms</strong> to select and convert 
the appropriate elements of the input documents.
</p>

<p>
Copy the file shown below to the <code>html-pdf</code> directory alongside your XML documents, naming it
<strong>doc2html.xsl</strong>
</p>

       <source><![CDATA[
<?xml version="1.0" encoding="iso-8859-1"?>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0">

<!-- generate HTML skeleton on root element -->
<xsl:template match="/">
  <html>
    <head>
      <title><xsl:apply-templates select="page/title"/></title>
    </head>
    <body>
        <xsl:apply-templates/>
    </body>
  </html>
</xsl:template>

<!-- story is used later by the Meerkat example -->
<xsl:template match="p|story">
    <p><xsl:apply-templates/></p>
</xsl:template>

<!-- convert sections to HTML headings -->
<xsl:template match="s1">
    <h1><xsl:apply-templates select="@title"/></h1>
    <xsl:apply-templates/>
</xsl:template>

</xsl:stylesheet>     
]]></source>
<note>       
Basically what this does is generate an HTML skeleton and convert the input markup to HTML. We won't go
into details here. Rather, our goal is to show you how the components of the publishing chain are combined.  
</note>

</s2>

<s2 title="4. Create the sitemap" >
<p>
We now have documents to publish and an XSLT transform to convert them to our HTML output format.
What's left is to connect them in a <strong>processing pipeline</strong>. Then, the <strong>sitemap</strong> can select the pipeline based on the details of the browser request.
</p>

<p>
To tell Cocoon how to process requests made to <code>html-pdf</code>, 
copy the following snippet to a file named <strong>sitemap.xmap</strong> in the 
<code>html-pdf</code> subdirectory.
</p>

       <source><![CDATA[
<?xml version="1.0" encoding="iso-8859-1"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

    <!-- define the Cocoon processing pipelines -->
    <map:pipelines>
        <map:pipeline>
            <!-- respond to *.html requests with
                 our docs processed by doc2html.xsl -->
            <map:match pattern="*.html">
                <map:generate src="{1}.xml"/>
                <map:transform src="doc2html.xsl"/>
                <map:serialize type="html"/>
            </map:match>

            <!-- later, respond to *.pdf requests with
                 our docs processed by doc2pdf.xsl -->
            <map:match pattern="*.pdf">
                <map:generate src="{1}.xml"/>
                <map:transform src="doc2pdf.xsl"/>
                <map:serialize type="fo2pdf"/>
            </map:match>
        </map:pipeline>
    </map:pipelines>
</map:sitemap>
        ]]></source>
        
<note>The important thing here is the first <strong>map:match</strong> element, which tells Cocoon how to process
requests ending in *.html in this directory. Again, we won't go into details here, but that's where it happens.
</note>
<note>The above sitemap is already configured for PDF publishing. However, this capability is not fully functional at this time because we haven't created the required XSLT transform yet.</note> 
       
</s2>

<s2 title="5. Test the HTML publishing" >
<p>
At this point you should be able to display the results in HTML: 
</p>
<ul>
<li>
<code>http://localhost:8888/html-pdf/pageOne.html</code>
should display the first page with "Section one" in big letters.
</li>
<li>
<code>http://localhost:8888/html-pdf/pageTwo.html</code>
should display the second page with "Yes it works" in big letters.
</li>
</ul>
<note>If this doesn't work, you might want to double check the above steps first, and then look at the Cocoon
logs (see the Cocoon wiki for information about the logs).
</note>
<note>
To convince yourself that the HTML data is generated dynamically, you can try to edit the pageXXX.xml source documents
(keeping them well-formed),
and refresh the browser to see the effect of your changes.
</note>
</s2>


<s2 title="6. Create the XSLT transform for PDF" >
<p>
PDF documents are created via XSL-FO documents which are XML documents that use a specific page-description
vocabulary. (See <link href="#references">References</link> below for more info). The actual conversion to PDF is done by the 
<code>PdfSerializer</code> which uses software from <link href="http://xml.apache.org/fop">FOP</link>, another Apache
Software Foundation project.   
</p>

<p>
To activate the PDF conversion, copy the code snippet shown below to the <code>html-pdf</code> directory along with your XML documents, and name it
<strong>doc2pdf.xsl</strong>
</p>

       <source><![CDATA[
<?xml version="1.0" encoding="iso-8859-1"?>
<xsl:stylesheet 
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform" version="1.0"
    xmlns:fo="http://www.w3.org/1999/XSL/Format"
>
    <!-- generate PDF page structure -->
    <xsl:template match="/">
        <fo:root xmlns:fo="http://www.w3.org/1999/XSL/Format">
            <fo:layout-master-set>
                <fo:simple-page-master master-name="page"
                  page-height="29.7cm" 
                  page-width="21cm"
                  margin-top="1cm" 
                  margin-bottom="2cm" 
                  margin-left="2.5cm" 
                  margin-right="2.5cm"
                >
                    <fo:region-before extent="3cm"/>
                    <fo:region-body margin-top="3cm"/>
                    <fo:region-after extent="1.5cm"/>
                </fo:simple-page-master>

                <fo:page-sequence-master master-name="all">
                    <fo:repeatable-page-master-alternatives>
                        <fo:conditional-page-master-reference 
                           master-reference="page" page-position="first"/>
                    </fo:repeatable-page-master-alternatives>
                </fo:page-sequence-master>
            </fo:layout-master-set>

            <fo:page-sequence master-reference="all">
                <fo:flow flow-name="xsl-region-body">
                    <fo:block><xsl:apply-templates/></fo:block>
                </fo:flow>
            </fo:page-sequence>
        </fo:root>
    </xsl:template>

    <!-- process paragraphs -->
    <xsl:template match="p">
        <fo:block><xsl:apply-templates/></fo:block>
    </xsl:template>

    <!-- convert sections to XSL-FO headings -->
    <xsl:template match="s1">
        <fo:block font-size="24pt" color="red" font-weight="bold">
            <xsl:apply-templates select="@title"/>
        </fo:block>
        <xsl:apply-templates/>
    </xsl:template>

</xsl:stylesheet>
]]>
       </source>
<note>This file is already referenced by the sitemap we created, so no additional configuration is needed.</note>       
</s2>

<s2 title="5. Test the PDF publishing" >
<p>
At this point you should be able to display the results in PDF in addition to the existing HTML versions: 
</p>
<ul>
<li>
<code>http://localhost:8888/html-pdf/pageOne.pdf</code>
should display the first page with "Section one" in big red letters.
</li>
<li>
<code>http://localhost:8888/html-pdf/pageTwo.pdf</code>
should display the second page with "Yes it works" in big red letters.
</li>
</ul>
</s2>

</s1>

<s1 title="Summary">
<p>
I hope you're beginning to see that publishing PDF and HTML documents in Cocoon is not too complicated, once you know what goes where. 
</p>
<p>
The nice thing is that all of our huge corpus
of XML documents (actually, only two documents right now, but that's a start... ) is processed by just two XSLT transforms, one
for each target format.
</p>
<p>
If you need to change the appearance of the published documents, you have to change only these two XSLT transforms. There's no need to touch the source documents.
</p>
</s1>

<s1 title="Tips">
<s2 title="Tip 1: Dynamic XML data">
<p>
Using dynamic XML as the data source is very easy because the Cocoon FileGenerator can read URLs as well. 
</p>
<p>
If you add the map:match element shown in bold below <strong>before</strong> the existing map:match elements in your sitemap.xmap file, requesting
<code>http://localhost:8888/html-pdf/meerkat.html</code>
should display real-time news from Meerkat (assuming an Internet connection to Meerkat is available).
</p>
<p>
The news will be displayed in a very rough format. However, this can be improved by writing a 
specific XSLT transform for this Meerkat data and using it, instead of doc2html.xsl, in the meerkat.html pipeline.  
</p>

<source>
<![CDATA[
...
<map:pipeline>
]]>
<strong>
<![CDATA[
<map:match pattern="meerkat.html">
    <map:generate src="http://www.oreillynet.com/meerkat/?_fl=xml"/>
    <map:transform src="doc2html.xsl"/>
    <map:serialize type="html"/>
</map:match>
]]>
</strong>
<![CDATA[
<map:match pattern="*.html">
etc...
]]>
</source>
</s2>

<s2 title="Tip 2: Two-step conversion">
<p>
When you are generating multiple formats from a single data source, it is often a good idea to generate 
an intermediate <strong>logical document</strong> that describes the output in a format-neutral way.
</p>
<p>
This is obviously not needed in our simple example. If you're aiming for more complicated 
publishing tasks, then you might want to read about this "publishing pattern" in Martin Fowler's 
<link href="http://martinfowler.com/eaaCatalog/twoStepView.html">Two Step View</link>
article.
</p>
</s2>

</s1>

<s1 title="References">
<anchor id="references"/>
<p>
To go further, you will need to learn about the following technologies and tools.
</p>
<ul>
<li>
Learning  
<link href="http://cocoon.apache.org/2.1/userdocs/concepts/index.html">
Cocoon concepts</link> will help you understand how the sitemap, generators, transformers, and serializers work.
</li> 
<li>
Learning about <link href="http://www.w3.org/Style/XSL/">XSLT</link> will enable you to write your own transforms to 
generate HTML, PDF or other formats from XML data. 
Information about XSL-FO is available at the same address.  
</li>
</ul>
</s1>

<s1 title="Comments">
<p>
Care to comment on this How-To? Got another tip? 
Help keep this How-To relevant by passing along any useful feedback to the author,
<link href="mailto:bdelacretaz@apache.org">Bertrand Delacr&#233;taz</link>.
</p>
</s1>

</body>
</document>
